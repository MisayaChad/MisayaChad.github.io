<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Misaya Chad Blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Chad的个人技术博客">
<meta property="og:type" content="website">
<meta property="og:title" content="Misaya Chad Blogs">
<meta property="og:url" content="http://misayachad.github.io/index.html">
<meta property="og:site_name" content="Misaya Chad Blogs">
<meta property="og:description" content="Chad的个人技术博客">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Misaya Chad Blogs">
<meta name="twitter:description" content="Chad的个人技术博客">
  
    <link rel="alternate" href="/atom.xml" title="Misaya Chad Blogs" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Misaya Chad Blogs</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Chad的个人技术博客</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://misayachad.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-超级账本 Hyperledger Fabric2.0 多机集群部署" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/05/20/超级账本 Hyperledger Fabric2.0 多机集群部署/" class="article-date">
  <time datetime="2020-05-20T07:33:30.000Z" itemprop="datePublished">2020-05-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/区块链/">区块链</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/20/超级账本 Hyperledger Fabric2.0 多机集群部署/">超级账本 Hyperledger Fabric2.0 多机集群部署</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="我们需要将容器分发到4个主机，本教程使用的是局域网下的四台主机。系统为Ubuntu和centos均可以。可以自己随便设置，保证能互相联通"><a href="#我们需要将容器分发到4个主机，本教程使用的是局域网下的四台主机。系统为Ubuntu和centos均可以。可以自己随便设置，保证能互相联通" class="headerlink" title="我们需要将容器分发到4个主机，本教程使用的是局域网下的四台主机。系统为Ubuntu和centos均可以。可以自己随便设置，保证能互相联通"></a>我们需要将容器分发到4个主机，本教程使用的是局域网下的四台主机。系统为Ubuntu和centos均可以。可以自己随便设置，保证能互相联通</h1><p><img src="/images/fabric2.0多机集群部署结构.jpg" alt=""></p>
<h2 id="在Fabric网络启动运行后，我们将使用Fabcar链码进行测试。总体流程如下："><a href="#在Fabric网络启动运行后，我们将使用Fabcar链码进行测试。总体流程如下：" class="headerlink" title="在Fabric网络启动运行后，我们将使用Fabcar链码进行测试。总体流程如下："></a>在Fabric网络启动运行后，我们将使用Fabcar链码进行测试。总体流程如下：</h2><p>准备4台可以互相通信的主机，均为linu内核。<br>构建一个叠加网络，将4个主机都加入该网络<br>在主机1上准备所有资料，包括密码学资料、通道配置交易、每个节点的docker-compose文件等。然后拷贝到其他主机。<br>使用docker-compose启动所有组件<br>创建通道mychannel并将所有peer加入该通道<br>安装并实例化Fabcar链码<br>调用查询链码方法</p>
<h3 id="使用Docker-Swarm构建叠加网络"><a href="#使用Docker-Swarm构建叠加网络" class="headerlink" title="使用Docker Swarm构建叠加网络"></a>使用Docker Swarm构建叠加网络</h3><ul>
<li><p>在host1初始化swarm集群</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker swarm init</div></pre></td></tr></table></figure>
</li>
<li><p>在host1上创建swarm网络</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker network create --attachable --driver overlay first-network</div></pre></td></tr></table></figure>
</li>
<li><p>在其余host上（以管理节点的身份）加入swarm网络</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker swarm join --token xxxxxxxxxxx</div></pre></td></tr></table></figure>
</li>
<li><p>验证每台host上是否有名称为first-network网络</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker network ls</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="在host1上准备材料"><a href="#在host1上准备材料" class="headerlink" title="在host1上准备材料"></a>在host1上准备材料</h3><ul>
<li>首先进入fabric-samples目录，如果还没有fabric-samples，自行在github上面去当去该项目，然后创建一个raft-4node-swarm目录。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cd fabric-samples</div><div class="line">mkdir raft-4node-swarm</div><div class="line">cd raft-4node-swarm</div></pre></td></tr></table></figure>
<ul>
<li><p>直接从first-network拷贝crypto-config.yaml和configtx.yaml文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cp ../first-network/crypto-config.yaml .</div><div class="line">cp ../first-network/configtx.yaml .</div></pre></td></tr></table></figure>
</li>
<li><p>直接从config拷贝core.yaml和orderer.yaml文件,并修改core.yaml中mspConfigPath内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cp ../config/core.yaml .</div><div class="line">cp ../config/orderer.yaml .</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="core-yaml更改前"><a href="#core-yaml更改前" class="headerlink" title="core.yaml更改前"></a>core.yaml更改前</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Path on the file system where peer will find MSP local configurations</span></div><div class="line"><span class="attr">   mspConfigPath:</span> <span class="string">msp</span></div></pre></td></tr></table></figure>
<h4 id="core-yaml更改后"><a href="#core-yaml更改后" class="headerlink" title="core.yaml更改后"></a>core.yaml更改后</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Path on the file system where peer will find MSP local configurations</span></div><div class="line"><span class="attr">   mspConfigPath:</span> <span class="string">crypto-config/ordererOrganizations/example.com/msp</span></div></pre></td></tr></table></figure>
<ul>
<li>其中 crypto-config.yaml 用于生成MSP相关证书，育有组织架构和节点数和first-network一样，所以不作修改。<br>其中configtx.yaml用于生成创世区块，交易通道配置等，由于节点的通信地址变化，所以共识机制配置中排序节点的通信地址要更改，更改内容如下</li>
</ul>
<h4 id="configtx-yaml更改前："><a href="#configtx-yaml更改前：" class="headerlink" title="configtx.yaml更改前："></a>configtx.yaml更改前：</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="bullet">-</span> <span class="meta">&amp;Org2</span></div><div class="line">     <span class="comment"># DefaultOrg defines the organization which is used in the sampleconfig</span></div><div class="line">     <span class="comment"># of the fabric.git development environment</span></div><div class="line"><span class="attr">     Name:</span> <span class="string">Org2MSP</span></div><div class="line"></div><div class="line">     <span class="comment"># ID to load the MSP definition as</span></div><div class="line"><span class="attr">     ID:</span> <span class="string">Org2MSP</span></div><div class="line"></div><div class="line"><span class="attr">     MSPDir:</span> <span class="string">crypto-config/peerOrganizations/org2.example.com/msp</span></div><div class="line"></div><div class="line">     <span class="comment"># Policies defines the set of policies at this level of the config tree</span></div><div class="line">     <span class="comment"># For organization policies, their canonical path is usually</span></div><div class="line">     <span class="comment">#   /Channel/&lt;Application|Orderer&gt;/&lt;OrgName&gt;/&lt;PolicyName&gt;</span></div><div class="line"><span class="attr">     Policies:</span></div><div class="line"><span class="attr">         Readers:</span></div><div class="line"><span class="attr">             Type:</span> <span class="string">Signature</span></div><div class="line"><span class="attr">             Rule:</span> <span class="string">"OR('Org2MSP.admin', 'Org2MSP.peer', 'Org2MSP.client')"</span></div><div class="line"><span class="attr">         Writers:</span></div><div class="line"><span class="attr">             Type:</span> <span class="string">Signature</span></div><div class="line"><span class="attr">             Rule:</span> <span class="string">"OR('Org2MSP.admin', 'Org2MSP.client')"</span></div><div class="line"><span class="attr">         Admins:</span></div><div class="line"><span class="attr">             Type:</span> <span class="string">Signature</span></div><div class="line"><span class="attr">             Rule:</span> <span class="string">"OR('Org2MSP.admin')"</span></div><div class="line"><span class="attr">         Endorsement:</span></div><div class="line"><span class="attr">             Type:</span> <span class="string">Signature</span></div><div class="line"><span class="attr">             Rule:</span> <span class="string">"OR('Org2MSP.peer')"</span></div><div class="line"></div><div class="line"><span class="attr">     AnchorPeers:</span></div><div class="line">         <span class="comment"># AnchorPeers defines the location of peers which can be used</span></div><div class="line">         <span class="comment"># for cross org gossip communication.  Note, this value is only</span></div><div class="line">         <span class="comment"># encoded in the genesis block in the Application section context</span></div><div class="line"><span class="attr">         - Host:</span> <span class="string">peer0.org2.example.com</span></div><div class="line"><span class="attr">           Port:</span> <span class="number">9051</span></div><div class="line"></div><div class="line"><span class="attr"> SampleMultiNodeEtcdRaft:</span></div><div class="line">     <span class="string">&lt;&lt;:</span> <span class="meta">*ChannelDefaults</span></div><div class="line"><span class="attr">     Capabilities:</span></div><div class="line">         <span class="string">&lt;&lt;:</span> <span class="meta">*ChannelCapabilities</span></div><div class="line"><span class="attr">     Orderer:</span></div><div class="line">         <span class="string">&lt;&lt;:</span> <span class="meta">*OrdererDefaults</span></div><div class="line"><span class="attr">         OrdererType:</span> <span class="string">etcdraft</span></div><div class="line"><span class="attr">         EtcdRaft:</span></div><div class="line"><span class="attr">             Consenters:</span></div><div class="line"><span class="attr">             - Host:</span> <span class="string">orderer.example.com</span></div><div class="line"><span class="attr">               Port:</span> <span class="number">7050</span></div><div class="line"><span class="attr">               ClientTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/tls/server.crt</span></div><div class="line"><span class="attr">               ServerTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/tls/server.crt</span></div><div class="line"><span class="attr">             - Host:</span> <span class="string">orderer2.example.com</span></div><div class="line"><span class="attr">               Port:</span> <span class="number">8050</span></div><div class="line"><span class="attr">               ClientTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer2.example.com/tls/server.crt</span></div><div class="line"><span class="attr">               ServerTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer2.example.com/tls/server.crt</span></div><div class="line"><span class="attr">             - Host:</span> <span class="string">orderer3.example.com</span></div><div class="line"><span class="attr">               Port:</span> <span class="number">9050</span></div><div class="line"><span class="attr">               ClientTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer3.example.com/tls/server.crt</span></div><div class="line"><span class="attr">               ServerTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer3.example.com/tls/server.crt</span></div><div class="line"><span class="attr">             - Host:</span> <span class="string">orderer4.example.com</span></div><div class="line"><span class="attr">               Port:</span> <span class="number">10050</span></div><div class="line"><span class="attr">               ClientTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer4.example.com/tls/server.crt</span></div><div class="line"><span class="attr">               ServerTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer4.example.com/tls/server.crt</span></div><div class="line"><span class="attr">             - Host:</span> <span class="string">orderer5.example.com</span></div><div class="line"><span class="attr">               Port:</span> <span class="number">11050</span></div><div class="line"><span class="attr">               ClientTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer5.example.com/tls/server.crt</span></div><div class="line"><span class="attr">               ServerTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer5.example.com/tls/server.crt</span></div><div class="line"><span class="attr">         Addresses:</span></div><div class="line"><span class="bullet">             -</span> <span class="string">orderer.example.com:7050</span></div><div class="line"><span class="bullet">             -</span> <span class="string">orderer2.example.com:8050</span></div><div class="line"><span class="bullet">             -</span> <span class="string">orderer3.example.com:9050</span></div><div class="line"><span class="bullet">             -</span> <span class="string">orderer4.example.com:10050</span></div><div class="line"><span class="bullet">             -</span> <span class="string">orderer5.example.com:11050</span></div></pre></td></tr></table></figure>
<h4 id="configtx-yaml更改后："><a href="#configtx-yaml更改后：" class="headerlink" title="configtx.yaml更改后："></a>configtx.yaml更改后：</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="bullet"> -</span> <span class="meta">&amp;Org2</span></div><div class="line">    <span class="comment"># DefaultOrg defines the organization which is used in the sampleconfig</span></div><div class="line">    <span class="comment"># of the fabric.git development environment</span></div><div class="line"><span class="attr">    Name:</span> <span class="string">Org2MSP</span></div><div class="line"></div><div class="line">    <span class="comment"># ID to load the MSP definition as</span></div><div class="line"><span class="attr">    ID:</span> <span class="string">Org2MSP</span></div><div class="line"></div><div class="line"><span class="attr">    MSPDir:</span> <span class="string">crypto-config/peerOrganizations/org2.example.com/msp</span></div><div class="line"></div><div class="line">    <span class="comment"># Policies defines the set of policies at this level of the config tree</span></div><div class="line">    <span class="comment"># For organization policies, their canonical path is usually</span></div><div class="line">    <span class="comment">#   /Channel/&lt;Application|Orderer&gt;/&lt;OrgName&gt;/&lt;PolicyName&gt;</span></div><div class="line"><span class="attr">    Policies:</span></div><div class="line"><span class="attr">        Readers:</span></div><div class="line"><span class="attr">            Type:</span> <span class="string">Signature</span></div><div class="line"><span class="attr">            Rule:</span> <span class="string">"OR('Org2MSP.admin', 'Org2MSP.peer', 'Org2MSP.client')"</span></div><div class="line"><span class="attr">        Writers:</span></div><div class="line"><span class="attr">            Type:</span> <span class="string">Signature</span></div><div class="line"><span class="attr">            Rule:</span> <span class="string">"OR('Org2MSP.admin', 'Org2MSP.client')"</span></div><div class="line"><span class="attr">        Admins:</span></div><div class="line"><span class="attr">            Type:</span> <span class="string">Signature</span></div><div class="line"><span class="attr">            Rule:</span> <span class="string">"OR('Org2MSP.admin')"</span></div><div class="line"><span class="attr">        Endorsement:</span></div><div class="line"><span class="attr">            Type:</span> <span class="string">Signature</span></div><div class="line"><span class="attr">            Rule:</span> <span class="string">"OR('Org2MSP.peer')"</span></div><div class="line"></div><div class="line"><span class="attr">    AnchorPeers:</span></div><div class="line">        <span class="comment"># AnchorPeers defines the location of peers which can be used</span></div><div class="line">        <span class="comment"># for cross org gossip communication.  Note, this value is only</span></div><div class="line">        <span class="comment"># encoded in the genesis block in the Application section context</span></div><div class="line"><span class="attr">        - Host:</span> <span class="string">peer0.org2.example.com</span></div><div class="line"><span class="attr">          Port:</span> <span class="number">7051</span></div><div class="line"></div><div class="line"><span class="attr">SampleMultiNodeEtcdRaft:</span></div><div class="line">    <span class="string">&lt;&lt;:</span> <span class="meta">*ChannelDefaults</span></div><div class="line"><span class="attr">    Capabilities:</span></div><div class="line">        <span class="string">&lt;&lt;:</span> <span class="meta">*ChannelCapabilities</span></div><div class="line"><span class="attr">    Orderer:</span></div><div class="line">        <span class="string">&lt;&lt;:</span> <span class="meta">*OrdererDefaults</span></div><div class="line"><span class="attr">        OrdererType:</span> <span class="string">etcdraft</span></div><div class="line"><span class="attr">        EtcdRaft:</span></div><div class="line"><span class="attr">            Consenters:</span></div><div class="line"><span class="attr">            - Host:</span> <span class="string">orderer.example.com</span></div><div class="line"><span class="attr">              Port:</span> <span class="number">7050</span></div><div class="line"><span class="attr">              ClientTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/tls/server.crt</span></div><div class="line"><span class="attr">              ServerTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/tls/server.crt</span></div><div class="line"><span class="attr">            - Host:</span> <span class="string">orderer2.example.com</span></div><div class="line"><span class="attr">              Port:</span> <span class="number">7050</span></div><div class="line"><span class="attr">              ClientTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer2.example.com/tls/server.crt</span></div><div class="line"><span class="attr">              ServerTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer2.example.com/tls/server.crt</span></div><div class="line"><span class="attr">            - Host:</span> <span class="string">orderer3.example.com</span></div><div class="line"><span class="attr">              Port:</span> <span class="number">7050</span></div><div class="line"><span class="attr">              ClientTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer3.example.com/tls/server.crt</span></div><div class="line"><span class="attr">              ServerTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer3.example.com/tls/server.crt</span></div><div class="line"><span class="attr">            - Host:</span> <span class="string">orderer4.example.com</span></div><div class="line"><span class="attr">              Port:</span> <span class="number">7050</span></div><div class="line"><span class="attr">              ClientTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer4.example.com/tls/server.crt</span></div><div class="line"><span class="attr">              ServerTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer4.example.com/tls/server.crt</span></div><div class="line"><span class="attr">            - Host:</span> <span class="string">orderer5.example.com</span></div><div class="line"><span class="attr">              Port:</span> <span class="number">8050</span></div><div class="line"><span class="attr">              ClientTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer5.example.com/tls/server.crt</span></div><div class="line"><span class="attr">              ServerTLSCert:</span> <span class="string">crypto-config/ordererOrganizations/example.com/orderers/orderer5.example.com/tls/server.crt</span></div><div class="line"><span class="attr">        Addresses:</span></div><div class="line"><span class="bullet">            -</span> <span class="string">orderer.example.com:7050</span></div><div class="line"><span class="bullet">            -</span> <span class="string">orderer2.example.com:7050</span></div><div class="line"><span class="bullet">            -</span> <span class="string">orderer3.example.com:7050</span></div><div class="line"><span class="bullet">            -</span> <span class="string">orderer4.example.com:7050</span></div><div class="line"><span class="bullet">            -</span> <span class="string">orderer5.example.com:8050</span></div></pre></td></tr></table></figure>
<h4 id="然后根据配置文件生成必要的密码学资料："><a href="#然后根据配置文件生成必要的密码学资料：" class="headerlink" title="然后根据配置文件生成必要的密码学资料："></a>然后根据配置文件生成必要的密码学资料：</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">../bin/cryptogen generate --config=./crypto-config.yaml</div><div class="line">export FABRIC_CFG_PATH=$PWD</div><div class="line">mkdir channel-artifacts</div><div class="line">../bin/configtxgen -profile SampleMultiNodeEtcdRaft -outputBlock ./channel-artifacts/genesis.block -channelID byfn-sys-channel</div><div class="line">../bin/configtxgen -profile TwoOrgsChannel -outputCreateChannelTx ./channel-artifacts/channel.tx -channelID mychannel</div><div class="line">../bin/configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/Org1MSPanchors.tx -channelID mychannel -asOrg Org1MSP</div><div class="line">../bin/configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/Org2MSPanchors.tx -channelID mychannel -asOrg Org2MSP</div></pre></td></tr></table></figure>
<h4 id="现在我们为所有主机准备docker-compose文件，主要基于BYFN中的文件，需要创建6个docker-compose文件以及一个env文件"><a href="#现在我们为所有主机准备docker-compose文件，主要基于BYFN中的文件，需要创建6个docker-compose文件以及一个env文件" class="headerlink" title="现在我们为所有主机准备docker-compose文件，主要基于BYFN中的文件，需要创建6个docker-compose文件以及一个env文件"></a>现在我们为所有主机准备docker-compose文件，主要基于BYFN中的文件，需要创建6个docker-compose文件以及一个env文件</h4><ul>
<li>base/peer-base.yaml</li>
<li>base/docker-compose-peer.yaml</li>
<li>host1.yaml</li>
<li>host2.yaml</li>
<li>host3.yaml</li>
<li>host4.yaml</li>
<li>.env</li>
</ul>
<h5 id="base-peer-base-yaml-内容："><a href="#base-peer-base-yaml-内容：" class="headerlink" title="base/peer-base.yaml 内容："></a>base/peer-base.yaml 内容：</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment"># Copyright IBM Corp. All Rights Reserved.</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># SPDX-License-Identifier: Apache-2.0</span></div><div class="line"><span class="comment">#</span></div><div class="line"></div><div class="line"><span class="attr">version:</span> <span class="string">'2'</span></div><div class="line"></div><div class="line"><span class="attr">services:</span></div><div class="line"><span class="attr">  peer-base:</span></div><div class="line"><span class="attr">    image:</span> <span class="string">hyperledger/fabric-peer:$IMAGE_TAG</span></div><div class="line"><span class="attr">    environment:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock</span></div><div class="line">      <span class="comment"># the following setting starts chaincode containers on the same</span></div><div class="line">      <span class="comment"># bridge network as the peers</span></div><div class="line">      <span class="comment"># https://docs.docker.com/compose/networking/</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=first-network</span></div><div class="line"><span class="bullet">      -</span> <span class="string">FABRIC_LOGGING_SPEC=INFO</span></div><div class="line">      <span class="comment">#- FABRIC_LOGGING_SPEC=DEBUG</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_TLS_ENABLED=true</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_GOSSIP_USELEADERELECTION=true</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_GOSSIP_ORGLEADER=false</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_PROFILE_ENABLED=true</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt</span></div><div class="line"><span class="attr">    working_dir:</span> <span class="string">/opt/gopath/src/github.com/hyperledger/fabric/peer</span></div><div class="line"><span class="attr">    command:</span> <span class="string">peer</span> <span class="string">node</span> <span class="string">start</span></div><div class="line"></div><div class="line"><span class="attr">  orderer-base:</span></div><div class="line"><span class="attr">    image:</span> <span class="string">hyperledger/fabric-orderer:$IMAGE_TAG</span></div><div class="line"><span class="attr">    environment:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">FABRIC_LOGGING_SPEC=INFO</span></div><div class="line"><span class="bullet">      -</span> <span class="string">ORDERER_GENERAL_LISTENADDRESS=0.0.0.0</span></div><div class="line"><span class="bullet">      -</span> <span class="string">ORDERER_GENERAL_GENESISMETHOD=file</span></div><div class="line"><span class="bullet">      -</span> <span class="string">ORDERER_GENERAL_GENESISFILE=/var/hyperledger/orderer/orderer.genesis.block</span></div><div class="line"><span class="bullet">      -</span> <span class="string">ORDERER_GENERAL_LOCALMSPID=OrdererMSP</span></div><div class="line"><span class="bullet">      -</span> <span class="string">ORDERER_GENERAL_LOCALMSPDIR=/var/hyperledger/orderer/msp</span></div><div class="line">      <span class="comment"># enabled TLS</span></div><div class="line"><span class="bullet">      -</span> <span class="string">ORDERER_GENERAL_TLS_ENABLED=true</span></div><div class="line"><span class="bullet">      -</span> <span class="string">ORDERER_GENERAL_TLS_PRIVATEKEY=/var/hyperledger/orderer/tls/server.key</span></div><div class="line"><span class="bullet">      -</span> <span class="string">ORDERER_GENERAL_TLS_CERTIFICATE=/var/hyperledger/orderer/tls/server.crt</span></div><div class="line"><span class="bullet">      -</span> <span class="string">ORDERER_GENERAL_TLS_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]</span></div><div class="line"><span class="bullet">      -</span> <span class="string">ORDERER_KAFKA_TOPIC_REPLICATIONFACTOR=1</span></div><div class="line"><span class="bullet">      -</span> <span class="string">ORDERER_KAFKA_VERBOSE=true</span></div><div class="line"><span class="bullet">      -</span> <span class="string">ORDERER_GENERAL_CLUSTER_CLIENTCERTIFICATE=/var/hyperledger/orderer/tls/server.crt</span></div><div class="line"><span class="bullet">      -</span> <span class="string">ORDERER_GENERAL_CLUSTER_CLIENTPRIVATEKEY=/var/hyperledger/orderer/tls/server.key</span></div><div class="line"><span class="bullet">      -</span> <span class="string">ORDERER_GENERAL_CLUSTER_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]</span></div><div class="line"><span class="attr">    working_dir:</span> <span class="string">/opt/gopath/src/github.com/hyperledger/fabric</span></div><div class="line"><span class="attr">    command:</span> <span class="string">orderer</span></div></pre></td></tr></table></figure>
<h5 id="base-docker-compose-base-yaml-内容"><a href="#base-docker-compose-base-yaml-内容" class="headerlink" title="base/docker-compose-base.yaml 内容:"></a>base/docker-compose-base.yaml 内容:</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment"># Copyright IBM Corp. All Rights Reserved.</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># SPDX-License-Identifier: Apache-2.0</span></div><div class="line"><span class="comment">#</span></div><div class="line"></div><div class="line"><span class="attr">version:</span> <span class="string">'2'</span></div><div class="line"></div><div class="line"><span class="attr">services:</span></div><div class="line"></div><div class="line">  <span class="string">orderer.example.com:</span></div><div class="line"><span class="attr">    container_name:</span> <span class="string">orderer.example.com</span></div><div class="line"><span class="attr">    extends:</span></div><div class="line"><span class="attr">      file:</span> <span class="string">peer-base.yaml</span></div><div class="line"><span class="attr">      service:</span> <span class="string">orderer-base</span></div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">../channel-artifacts/genesis.block:/var/hyperledger/orderer/orderer.genesis.block</span></div><div class="line"><span class="bullet">        -</span> <span class="string">../crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/msp:/var/hyperledger/orderer/msp</span></div><div class="line"><span class="bullet">        -</span> <span class="string">../crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/tls/:/var/hyperledger/orderer/tls</span></div><div class="line"><span class="bullet">        -</span> <span class="string">orderer.example.com:/var/hyperledger/production/orderer</span></div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">      -</span> <span class="number">7050</span><span class="string">:7050</span></div><div class="line"></div><div class="line">  <span class="string">peer0.org1.example.com:</span></div><div class="line"><span class="attr">    container_name:</span> <span class="string">peer0.org1.example.com</span></div><div class="line"><span class="attr">    extends:</span></div><div class="line"><span class="attr">      file:</span> <span class="string">peer-base.yaml</span></div><div class="line"><span class="attr">      service:</span> <span class="string">peer-base</span></div><div class="line"><span class="attr">    environment:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_ID=peer0.org1.example.com</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_ADDRESS=peer0.org1.example.com:7051</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_LISTENADDRESS=0.0.0.0:7051</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_CHAINCODEADDRESS=peer0.org1.example.com:7052</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:7052</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_GOSSIP_BOOTSTRAP=peer1.org1.example.com:7051</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.org1.example.com:7051</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_LOCALMSPID=Org1MSP</span></div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">/var/run/:/host/var/run/</span></div><div class="line"><span class="bullet">        -</span> <span class="string">../crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/msp:/etc/hyperledger/fabric/msp</span></div><div class="line"><span class="bullet">        -</span> <span class="string">../crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls:/etc/hyperledger/fabric/tls</span></div><div class="line"><span class="bullet">        -</span> <span class="string">peer0.org1.example.com:/var/hyperledger/production</span></div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">      -</span> <span class="number">7051</span><span class="string">:7051</span></div><div class="line"></div><div class="line">  <span class="string">peer1.org1.example.com:</span></div><div class="line"><span class="attr">    container_name:</span> <span class="string">peer1.org1.example.com</span></div><div class="line"><span class="attr">    extends:</span></div><div class="line"><span class="attr">      file:</span> <span class="string">peer-base.yaml</span></div><div class="line"><span class="attr">      service:</span> <span class="string">peer-base</span></div><div class="line"><span class="attr">    environment:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_ID=peer1.org1.example.com</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_ADDRESS=peer1.org1.example.com:7051</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_LISTENADDRESS=0.0.0.0:7051</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_CHAINCODEADDRESS=peer1.org1.example.com:7052</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:7052</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer1.org1.example.com:7051</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_GOSSIP_BOOTSTRAP=peer0.org1.example.com:7051</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_LOCALMSPID=Org1MSP</span></div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">/var/run/:/host/var/run/</span></div><div class="line"><span class="bullet">        -</span> <span class="string">../crypto-config/peerOrganizations/org1.example.com/peers/peer1.org1.example.com/msp:/etc/hyperledger/fabric/msp</span></div><div class="line"><span class="bullet">        -</span> <span class="string">../crypto-config/peerOrganizations/org1.example.com/peers/peer1.org1.example.com/tls:/etc/hyperledger/fabric/tls</span></div><div class="line"><span class="bullet">        -</span> <span class="string">peer1.org1.example.com:/var/hyperledger/production</span></div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">      -</span> <span class="number">7051</span><span class="string">:7051</span></div><div class="line"></div><div class="line">  <span class="string">peer0.org2.example.com:</span></div><div class="line"><span class="attr">    container_name:</span> <span class="string">peer0.org2.example.com</span></div><div class="line"><span class="attr">    extends:</span></div><div class="line"><span class="attr">      file:</span> <span class="string">peer-base.yaml</span></div><div class="line"><span class="attr">      service:</span> <span class="string">peer-base</span></div><div class="line"><span class="attr">    environment:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_ID=peer0.org2.example.com</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_ADDRESS=peer0.org2.example.com:7051</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_LISTENADDRESS=0.0.0.0:7051</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_CHAINCODEADDRESS=peer0.org2.example.com:7052</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:7052</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.org2.example.com:7051</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_GOSSIP_BOOTSTRAP=peer1.org2.example.com:7051</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_LOCALMSPID=Org2MSP</span></div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">/var/run/:/host/var/run/</span></div><div class="line"><span class="bullet">        -</span> <span class="string">../crypto-config/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/msp:/etc/hyperledger/fabric/msp</span></div><div class="line"><span class="bullet">        -</span> <span class="string">../crypto-config/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls:/etc/hyperledger/fabric/tls</span></div><div class="line"><span class="bullet">        -</span> <span class="string">peer0.org2.example.com:/var/hyperledger/production</span></div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">      -</span> <span class="number">7051</span><span class="string">:7051</span></div><div class="line"></div><div class="line">  <span class="string">peer1.org2.example.com:</span></div><div class="line"><span class="attr">    container_name:</span> <span class="string">peer1.org2.example.com</span></div><div class="line"><span class="attr">    extends:</span></div><div class="line"><span class="attr">      file:</span> <span class="string">peer-base.yaml</span></div><div class="line"><span class="attr">      service:</span> <span class="string">peer-base</span></div><div class="line"><span class="attr">    environment:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_ID=peer1.org2.example.com</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_ADDRESS=peer1.org2.example.com:7051</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_LISTENADDRESS=0.0.0.0:7051</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_CHAINCODEADDRESS=peer1.org2.example.com:7052</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:7052</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer1.org2.example.com:7051</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_GOSSIP_BOOTSTRAP=peer0.org2.example.com:7051</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_LOCALMSPID=Org2MSP</span></div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">/var/run/:/host/var/run/</span></div><div class="line"><span class="bullet">        -</span> <span class="string">../crypto-config/peerOrganizations/org2.example.com/peers/peer1.org2.example.com/msp:/etc/hyperledger/fabric/msp</span></div><div class="line"><span class="bullet">        -</span> <span class="string">../crypto-config/peerOrganizations/org2.example.com/peers/peer1.org2.example.com/tls:/etc/hyperledger/fabric/tls</span></div><div class="line"><span class="bullet">        -</span> <span class="string">peer1.org2.example.com:/var/hyperledger/production</span></div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">      -</span> <span class="number">7051</span><span class="string">:7051</span></div></pre></td></tr></table></figure>
<h5 id="host1-yaml-内容"><a href="#host1-yaml-内容" class="headerlink" title="host1.yaml 内容:"></a>host1.yaml 内容:</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment"># Copyright IBM Corp. All Rights Reserved.</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># SPDX-License-Identifier: Apache-2.0</span></div><div class="line"><span class="comment">#</span></div><div class="line"></div><div class="line"><span class="attr">version:</span> <span class="string">'2'</span></div><div class="line"></div><div class="line"><span class="attr">volumes:</span></div><div class="line">  <span class="string">orderer.example.com:</span></div><div class="line">  <span class="string">orderer5.example.com:</span></div><div class="line">  <span class="string">peer0.org1.example.com:</span></div><div class="line"></div><div class="line"><span class="attr">networks:</span></div><div class="line"><span class="attr">  byfn:</span></div><div class="line"><span class="attr">    external:</span></div><div class="line"><span class="attr">      name:</span> <span class="string">first-network</span></div><div class="line"></div><div class="line"><span class="attr">services:</span></div><div class="line"></div><div class="line">  <span class="string">orderer.example.com:</span></div><div class="line"><span class="attr">    extends:</span></div><div class="line"><span class="attr">      file:</span>   <span class="string">base/docker-compose-base.yaml</span></div><div class="line"><span class="attr">      service:</span> <span class="string">orderer.example.com</span></div><div class="line"><span class="attr">    container_name:</span> <span class="string">orderer.example.com</span></div><div class="line"><span class="attr">    networks:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">byfn</span></div><div class="line"></div><div class="line">  <span class="string">orderer5.example.com:</span></div><div class="line"><span class="attr">    extends:</span></div><div class="line"><span class="attr">      file:</span> <span class="string">base/peer-base.yaml</span></div><div class="line"><span class="attr">      service:</span> <span class="string">orderer-base</span></div><div class="line"><span class="attr">    environment:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">ORDERER_GENERAL_LISTENPORT=7050</span></div><div class="line"><span class="attr">    container_name:</span> <span class="string">orderer5.example.com</span></div><div class="line"><span class="attr">    networks:</span></div><div class="line"><span class="bullet">    -</span> <span class="string">byfn</span></div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">./channel-artifacts/genesis.block:/var/hyperledger/orderer/orderer.genesis.block</span></div><div class="line"><span class="bullet">        -</span> <span class="string">./crypto-config/ordererOrganizations/example.com/orderers/orderer5.example.com/msp:/var/hyperledger/orderer/msp</span></div><div class="line"><span class="bullet">        -</span> <span class="string">./crypto-config/ordererOrganizations/example.com/orderers/orderer5.example.com/tls/:/var/hyperledger/orderer/tls</span></div><div class="line"><span class="bullet">        -</span> <span class="string">orderer5.example.com:/var/hyperledger/production/orderer</span></div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">    -</span> <span class="number">8050</span><span class="string">:7050</span></div><div class="line"></div><div class="line">  <span class="string">peer0.org1.example.com:</span></div><div class="line"><span class="attr">    container_name:</span> <span class="string">peer0.org1.example.com</span></div><div class="line"><span class="attr">    extends:</span></div><div class="line"><span class="attr">      file:</span>  <span class="string">base/docker-compose-base.yaml</span></div><div class="line"><span class="attr">      service:</span> <span class="string">peer0.org1.example.com</span></div><div class="line"><span class="attr">    networks:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">byfn</span></div><div class="line"></div><div class="line"><span class="attr">  cli:</span></div><div class="line"><span class="attr">    container_name:</span> <span class="string">cli</span></div><div class="line"><span class="attr">    image:</span> <span class="string">hyperledger/fabric-tools:$IMAGE_TAG</span></div><div class="line"><span class="attr">    tty:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    stdin_open:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    environment:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">SYS_CHANNEL=$SYS_CHANNEL</span></div><div class="line"><span class="bullet">      -</span> <span class="string">GOPATH=/opt/gopath</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock</span></div><div class="line">      <span class="comment">#- FABRIC_LOGGING_SPEC=DEBUG</span></div><div class="line"><span class="bullet">      -</span> <span class="string">FABRIC_LOGGING_SPEC=INFO</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_ID=cli</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_ADDRESS=peer0.org1.example.com:7051</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_LOCALMSPID=Org1MSP</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_TLS_ENABLED=true</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_TLS_CERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.crt</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_TLS_KEY_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.key</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp</span></div><div class="line"><span class="attr">    working_dir:</span> <span class="string">/opt/gopath/src/github.com/hyperledger/fabric/peer</span></div><div class="line"><span class="attr">    command:</span> <span class="string">/bin/bash</span></div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">/var/run/:/host/var/run/</span></div><div class="line"><span class="bullet">        -</span> <span class="string">./../chaincode/:/opt/gopath/src/github.com/chaincode</span></div><div class="line"><span class="bullet">        -</span> <span class="string">./crypto-config:/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/</span></div><div class="line"><span class="bullet">        -</span> <span class="string">./scripts:/opt/gopath/src/github.com/hyperledger/fabric/peer/scripts/</span></div><div class="line"><span class="bullet">        -</span> <span class="string">./channel-artifacts:/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts</span></div><div class="line"><span class="attr">    depends_on:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">orderer.example.com</span></div><div class="line"><span class="bullet">      -</span> <span class="string">peer0.org1.example.com</span></div><div class="line"><span class="attr">    networks:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">byfn</span></div></pre></td></tr></table></figure>
<h5 id="host2-yaml-内容"><a href="#host2-yaml-内容" class="headerlink" title="host2.yaml 内容:"></a>host2.yaml 内容:</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment"># Copyright IBM Corp. All Rights Reserved.</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># SPDX-License-Identifier: Apache-2.0</span></div><div class="line"><span class="comment">#</span></div><div class="line"></div><div class="line"><span class="attr">version:</span> <span class="string">'2'</span></div><div class="line"></div><div class="line"><span class="attr">volumes:</span></div><div class="line">  <span class="string">orderer2.example.com:</span></div><div class="line">  <span class="string">peer1.org1.example.com:</span></div><div class="line"></div><div class="line"><span class="attr">networks:</span></div><div class="line"><span class="attr">  byfn:</span></div><div class="line"><span class="attr">    external:</span></div><div class="line"><span class="attr">      name:</span> <span class="string">first-network</span></div><div class="line"></div><div class="line"><span class="attr">services:</span></div><div class="line"></div><div class="line">  <span class="string">orderer2.example.com:</span></div><div class="line"><span class="attr">    extends:</span></div><div class="line"><span class="attr">      file:</span> <span class="string">base/peer-base.yaml</span></div><div class="line"><span class="attr">      service:</span> <span class="string">orderer-base</span></div><div class="line"><span class="attr">    container_name:</span> <span class="string">orderer2.example.com</span></div><div class="line"><span class="attr">    networks:</span></div><div class="line"><span class="bullet">    -</span> <span class="string">byfn</span></div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">./channel-artifacts/genesis.block:/var/hyperledger/orderer/orderer.genesis.block</span></div><div class="line"><span class="bullet">        -</span> <span class="string">./crypto-config/ordererOrganizations/example.com/orderers/orderer2.example.com/msp:/var/hyperledger/orderer/msp</span></div><div class="line"><span class="bullet">        -</span> <span class="string">./crypto-config/ordererOrganizations/example.com/orderers/orderer2.example.com/tls/:/var/hyperledger/orderer/tls</span></div><div class="line"><span class="bullet">        -</span> <span class="string">orderer2.example.com:/var/hyperledger/production/orderer</span></div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">    -</span> <span class="number">7050</span><span class="string">:7050</span></div><div class="line"></div><div class="line">  <span class="string">peer1.org1.example.com:</span></div><div class="line"><span class="attr">    container_name:</span> <span class="string">peer1.org1.example.com</span></div><div class="line"><span class="attr">    extends:</span></div><div class="line"><span class="attr">      file:</span>  <span class="string">base/docker-compose-base.yaml</span></div><div class="line"><span class="attr">      service:</span> <span class="string">peer1.org1.example.com</span></div><div class="line"><span class="attr">    networks:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">byfn</span></div></pre></td></tr></table></figure>
<h5 id="host3-yaml-内容"><a href="#host3-yaml-内容" class="headerlink" title="host3.yaml 内容:"></a>host3.yaml 内容:</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment"># Copyright IBM Corp. All Rights Reserved.</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># SPDX-License-Identifier: Apache-2.0</span></div><div class="line"><span class="comment">#</span></div><div class="line"></div><div class="line"><span class="attr">version:</span> <span class="string">'2'</span></div><div class="line"></div><div class="line"><span class="attr">volumes:</span></div><div class="line">  <span class="string">orderer3.example.com:</span>  </div><div class="line">  <span class="string">peer0.org2.example.com:</span></div><div class="line"></div><div class="line"><span class="attr">networks:</span></div><div class="line"><span class="attr">  byfn:</span></div><div class="line"><span class="attr">    external:</span></div><div class="line"><span class="attr">      name:</span> <span class="string">first-network</span></div><div class="line"></div><div class="line"><span class="attr">services:</span></div><div class="line"></div><div class="line">  <span class="string">orderer3.example.com:</span></div><div class="line"><span class="attr">    extends:</span></div><div class="line"><span class="attr">      file:</span> <span class="string">base/peer-base.yaml</span></div><div class="line"><span class="attr">      service:</span> <span class="string">orderer-base</span></div><div class="line"><span class="attr">    container_name:</span> <span class="string">orderer3.example.com</span></div><div class="line"><span class="attr">    networks:</span></div><div class="line"><span class="bullet">    -</span> <span class="string">byfn</span></div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">./channel-artifacts/genesis.block:/var/hyperledger/orderer/orderer.genesis.block</span></div><div class="line"><span class="bullet">        -</span> <span class="string">./crypto-config/ordererOrganizations/example.com/orderers/orderer3.example.com/msp:/var/hyperledger/orderer/msp</span></div><div class="line"><span class="bullet">        -</span> <span class="string">./crypto-config/ordererOrganizations/example.com/orderers/orderer3.example.com/tls/:/var/hyperledger/orderer/tls</span></div><div class="line"><span class="bullet">        -</span> <span class="string">orderer3.example.com:/var/hyperledger/production/orderer</span></div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">    -</span> <span class="number">7050</span><span class="string">:7050</span></div><div class="line"></div><div class="line">  <span class="string">peer0.org2.example.com:</span></div><div class="line"><span class="attr">    container_name:</span> <span class="string">peer0.org2.example.com</span></div><div class="line"><span class="attr">    extends:</span></div><div class="line"><span class="attr">      file:</span>  <span class="string">base/docker-compose-base.yaml</span></div><div class="line"><span class="attr">      service:</span> <span class="string">peer0.org2.example.com</span></div><div class="line"><span class="attr">    networks:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">byfn</span></div></pre></td></tr></table></figure>
<h5 id="host4-yaml-内容"><a href="#host4-yaml-内容" class="headerlink" title="host4.yaml 内容:"></a>host4.yaml 内容:</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment"># Copyright IBM Corp. All Rights Reserved.</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># SPDX-License-Identifier: Apache-2.0</span></div><div class="line"><span class="comment">#</span></div><div class="line"></div><div class="line"><span class="attr">version:</span> <span class="string">'2'</span></div><div class="line"></div><div class="line"><span class="attr">volumes:</span></div><div class="line">  <span class="string">orderer4.example.com:</span></div><div class="line">  <span class="string">peer1.org2.example.com:</span></div><div class="line"></div><div class="line"><span class="attr">networks:</span></div><div class="line"><span class="attr">  byfn:</span></div><div class="line"><span class="attr">    external:</span></div><div class="line"><span class="attr">      name:</span> <span class="string">first-network</span></div><div class="line"></div><div class="line"><span class="attr">services:</span></div><div class="line"></div><div class="line">  <span class="string">orderer4.example.com:</span></div><div class="line"><span class="attr">    extends:</span></div><div class="line"><span class="attr">      file:</span> <span class="string">base/peer-base.yaml</span></div><div class="line"><span class="attr">      service:</span> <span class="string">orderer-base</span></div><div class="line"><span class="attr">    container_name:</span> <span class="string">orderer4.example.com</span></div><div class="line"><span class="attr">    networks:</span></div><div class="line"><span class="bullet">    -</span> <span class="string">byfn</span></div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">./channel-artifacts/genesis.block:/var/hyperledger/orderer/orderer.genesis.block</span></div><div class="line"><span class="bullet">        -</span> <span class="string">./crypto-config/ordererOrganizations/example.com/orderers/orderer4.example.com/msp:/var/hyperledger/orderer/msp</span></div><div class="line"><span class="bullet">        -</span> <span class="string">./crypto-config/ordererOrganizations/example.com/orderers/orderer4.example.com/tls/:/var/hyperledger/orderer/tls</span></div><div class="line"><span class="bullet">        -</span> <span class="string">orderer4.example.com:/var/hyperledger/production/orderer</span></div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">    -</span> <span class="number">7050</span><span class="string">:7050</span></div><div class="line"></div><div class="line">  <span class="string">peer1.org2.example.com:</span></div><div class="line"><span class="attr">    container_name:</span> <span class="string">peer1.org2.example.com</span></div><div class="line"><span class="attr">    extends:</span></div><div class="line"><span class="attr">      file:</span>  <span class="string">base/docker-compose-base.yaml</span></div><div class="line"><span class="attr">      service:</span> <span class="string">peer1.org2.example.com</span></div><div class="line"><span class="attr">    networks:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">byfn</span></div></pre></td></tr></table></figure>
<h5 id="env-（项目环境配置文件）内容"><a href="#env-（项目环境配置文件）内容" class="headerlink" title=".env （项目环境配置文件）内容"></a>.env （项目环境配置文件）内容</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">COMPOSE_PROJECT_NAME=net</div><div class="line">IMAGE_TAG=latest</div><div class="line">SYS_CHANNEL=byfn-sys-channel</div></pre></td></tr></table></figure>
<h4 id="以上文件具体是针对BYFN中的文件所作的修改总结"><a href="#以上文件具体是针对BYFN中的文件所作的修改总结" class="headerlink" title="以上文件具体是针对BYFN中的文件所作的修改总结"></a>以上文件具体是针对BYFN中的文件所作的修改总结</h4><ul>
<li>base/peer-base.yaml中，CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE修改为<br>我们之前创建的叠加网络first-network</li>
<li>base/docker-compose-base.yaml中，由于所有的peers都在不同的主机上，我们<br>将端口映射改回7051:7051。在每个peer的环境变量中也进行了相应的修改。</li>
<li>在所有的hostn.yaml文件中，我们添加叠加网络first-network</li>
</ul>
<h4 id="拷贝材料到其余机器"><a href="#拷贝材料到其余机器" class="headerlink" title="拷贝材料到其余机器"></a>拷贝材料到其余机器</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">cd ..</div><div class="line">tar cf raft-4node-swarm.tar raft-4node-swarm</div><div class="line">scp raft-4node-swarm.tar root@192.168.1.25:/root/go/src/github.com/hyperledger/fabric-samples</div><div class="line">scp raft-4node-swarm.tar root@192.168.1.27:/root/go/src/github.com/hyperledger/fabric-samples</div><div class="line">scp raft-4node-swarm.tar root@192.168.1.28:/root/go/src/github.com/hyperledger/fabric-samples</div></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">#</span>在host1、host2、host3上分别执行</div><div class="line">cd /root/go/src/github.com/hyperledger/fabric-samples</div><div class="line">rm -rf raft-4node-swarm</div><div class="line">tar xf raft-4node-swarm.tar</div><div class="line">cd raft-4node-swarm</div></pre></td></tr></table></figure>
<h4 id="分别启动各主机上的容器"><a href="#分别启动各主机上的容器" class="headerlink" title="分别启动各主机上的容器"></a>分别启动各主机上的容器</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">#</span> on Host 1, 2, 3 and 4, bring up corresponding yaml file</div><div class="line">docker-compose -f hostn.yaml up -d</div></pre></td></tr></table></figure>
<h4 id="为mychannel通道创建创世区块"><a href="#为mychannel通道创建创世区块" class="headerlink" title="为mychannel通道创建创世区块"></a>为mychannel通道创建创世区块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">docker exec cli peer channel create -o orderer.example.com:7050 -c mychannel \</div><div class="line">       -f ./channel-artifacts/channel.tx --tls true \</div><div class="line">       --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem</div></pre></td></tr></table></figure>
<h4 id="将peer0-org1加入mychannel"><a href="#将peer0-org1加入mychannel" class="headerlink" title="将peer0.org1加入mychannel"></a>将peer0.org1加入mychannel</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">docker exec cli peer channel join -b mychannel.block</div></pre></td></tr></table></figure>
<h4 id="将peer1-org1加入mychannel"><a href="#将peer1-org1加入mychannel" class="headerlink" title="将peer1.org1加入mychannel"></a>将peer1.org1加入mychannel</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">docker exec -e CORE_PEER_ADDRESS=peer1.org1.example.com:7051 \</div><div class="line">       -e CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer1.org1.example.com/tls/ca.crt \</div><div class="line">       cli peer channel join -b mychannel.block</div></pre></td></tr></table></figure>
<h4 id="将peer0-org2加入mychannel"><a href="#将peer0-org2加入mychannel" class="headerlink" title="将peer0.org2加入mychannel"></a>将peer0.org2加入mychannel</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">docker exec -e CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp \</div><div class="line">       -e CORE_PEER_ADDRESS=peer0.org2.example.com:7051 -e CORE_PEER_LOCALMSPID="Org2MSP" \</div><div class="line">       -e CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt \</div><div class="line">       cli peer channel join -b mychannel.block</div></pre></td></tr></table></figure>
<h4 id="将peer1-org2加入mychannel"><a href="#将peer1-org2加入mychannel" class="headerlink" title="将peer1.org2加入mychannel"></a>将peer1.org2加入mychannel</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">docker exec -e CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp \</div><div class="line">       -e CORE_PEER_ADDRESS=peer1.org2.example.com:7051 -e CORE_PEER_LOCALMSPID="Org2MSP" \</div><div class="line">       -e CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer1.org2.example.com/tls/ca.crt \</div><div class="line">       cli peer channel join -b mychannel.block</div></pre></td></tr></table></figure>
<h4 id="安装并实例化Fabcar链码"><a href="#安装并实例化Fabcar链码" class="headerlink" title="安装并实例化Fabcar链码"></a>安装并实例化Fabcar链码</h4><p>进入到docker的cli终端<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">docker exec -it cli bash</div></pre></td></tr></table></figure></p>
<p>查看当前cli容器环境变量<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">env</div></pre></td></tr></table></figure></p>
<p>正常会显示 CORE_PEER_LOCALMSPID=Org1MSP，表示以org1MSP身份操作</p>
<h4 id="打包合约"><a href="#打包合约" class="headerlink" title="打包合约"></a>打包合约</h4><p>在cli容器内部执行<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">peer lifecycle chaincode package mycc1.tar.gz --path /opt/gopath/src/github.com/chaincode/abstore/go/ --lang golang --label mycc_1</div><div class="line"></div><div class="line"><span class="meta">#</span> mycc1.tar.gz ：打包合约包文件名 </div><div class="line"><span class="meta">#</span> --path 智能合约路径,可以在host1.yaml中查看cli容器的数据卷配置查询</div><div class="line"><span class="meta">#</span> --lang 智能合约语言 支持golang、node、java</div><div class="line"><span class="meta">#</span> --label  智能合约标签，描述作用</div></pre></td></tr></table></figure></p>
<p>执行完成后，查看当前目录，会出现mycc1.tar.gz</p>
<h4 id="部署合约到节点"><a href="#部署合约到节点" class="headerlink" title="部署合约到节点"></a>部署合约到节点</h4><p>继续在cli内部执行以下命令,执行安装合约<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">peer lifecycle chaincode install mycc1.tar.gz</div></pre></td></tr></table></figure></p>
<p>验证合约安装是否安装到节点<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">peer lifecycle chaincode queryinstalled</div></pre></td></tr></table></figure></p>
<p>注意: 显示所有安装的合约包，记录label为mycc1的 Package ID</p>
<h4 id="当前组织同意合约定义"><a href="#当前组织同意合约定义" class="headerlink" title="当前组织同意合约定义"></a>当前组织同意合约定义</h4><p>2.0智能合约由合约定义控制。当通道成员批准合约定义时，该批准作为组织对其接受的合约参数的投票。这些经过批准的组织定义允许通道成员在链码在通道上使用之前对链码达成一致。链码定义包括以下参数，这些参数需要在组织之间保持一致:</p>
<p>名称: 智能合约名称<br>版本: 与给定的合约包相关联的版本号或值。如果您升级了合约二进制文件，那么您也需要更改合约版本。<br>序列: 定义链码的次数。此值为整数，用于跟踪合约升级。例如，当您第一次安装并批准一个chaincode定义时，序列号将是1。下次升级合约时，序列号将增加到2。<br>背书策略: 哪些组织需要执行和验证事务输出。背书策略可以表示为传递给CLI或SDK的字符串，也可以在通道配置中引用策略。默认情况下，背书策略被设置为通道/应用程序/背书，这默认要求通道中的大多数组织对交易进行背书。<br>集合配置: 指向与您的chaincode关联的私有数据集合定义文件的路径。有关私有数据收集的更多信息，请参见私有数据体系结构参考。<br>初始化: 所有的链码需要包含一个初始化函数来初始化链码。默认情况下，这个函数永远不会执行。但是，您可以使用chaincode定义来请求Init函数是可调用的。如果请求执行Init，则fabric将确保在调用任何其他函数之前调用Init，并且只调用一次。<br>ESCC/VSCC插件: 自定义认证或验证插件的名称。</p>
<p>cli容器输入以下命令<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">peer lifecycle chaincode approveformyorg --tls true \</div><div class="line"> --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem \</div><div class="line"> --channelID mychannel --name mycc1 --version 1 --init-required --package-id mycc_1:aa699dad960f7244415b3133713bb5222657382e1694c926f175bf177f573737 --sequence 1 --waitForEvent</div><div class="line"></div><div class="line"><span class="meta">#</span> --tls 是否启动tls</div><div class="line"><span class="meta">#</span> --ca ca证书路径</div><div class="line"><span class="meta">#</span> --channelID 智能合约安装通道</div><div class="line"><span class="meta">#</span> --name 合约名</div><div class="line"><span class="meta">#</span> --version 合约版本</div><div class="line"><span class="meta">#</span> --package-id queryinstalled查询的合约ID</div><div class="line"><span class="meta">#</span> --sequence 序列号</div><div class="line"><span class="meta">#</span> --waitForEvent 等待peer提交交易返回</div><div class="line"><span class="meta">#</span> --init-required 合约是否必须执行init</div></pre></td></tr></table></figure></p>
<h4 id="检查合约定义是否满足策略"><a href="#检查合约定义是否满足策略" class="headerlink" title="检查合约定义是否满足策略"></a>检查合约定义是否满足策略</h4><p>2.0的智能合约的部署必须满足一定合约定义策略，策略的定义在通道配置中具体定义<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">peer lifecycle chaincode checkcommitreadiness --channelID mychannel --name mycc1  --version 1 --sequence 1 --output json --init-required</div></pre></td></tr></table></figure></p>
<p>输出以下结果<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"approvals"</span>: &#123;</div><div class="line">    <span class="attr">"Org1MSP"</span>: <span class="literal">true</span>,</div><div class="line">    <span class="attr">"Org2MSP"</span>: <span class="literal">false</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>原因是lifecycle策略定义是满足过半数即可<br>这时候我们需要把Org2MSP也同意这个合约定义，切换环境变量为peer0.org2.example.com的配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">export CORE_PEER_LOCALMSPID=Org2MSP</div><div class="line">export CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt</div><div class="line">export CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp</div><div class="line">export CORE_PEER_ADDRESS=peer0.org2.example.com:7051</div></pre></td></tr></table></figure>
<p>以Org2MSP身份执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">peer lifecycle chaincode install mycc1.tar.gz</div><div class="line">peer lifecycle chaincode queryinstalled</div><div class="line"></div><div class="line"><span class="meta">#</span> 注意: 显示所有安装的合约包，记录label为mycc1的 Package ID</div></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">peer lifecycle chaincode approveformyorg --tls true \</div><div class="line"> --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem \</div><div class="line"> --channelID mychannel --name mycc1 --version 1 --init-required --package-id mycc_1:aa699dad960f7244415b3133713bb5222657382e1694c926f175bf177f573737 --sequence 1 --waitForEvent</div><div class="line"></div><div class="line"> peer lifecycle chaincode checkcommitreadiness --channelID mychannel --name mycc1  --version 1 --sequence 1 --output json --init-required</div></pre></td></tr></table></figure>
<p>输出以下结果<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"approvals"</span>: &#123;</div><div class="line">    <span class="attr">"Org1MSP"</span>: <span class="literal">true</span>,</div><div class="line">    <span class="attr">"Org2MSP"</span>: <span class="literal">true</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="提交合约"><a href="#提交合约" class="headerlink" title="提交合约"></a>提交合约</h4><p>在满足合约定义的策略后，可以提交合约<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">peer lifecycle chaincode commit -o orderer.example.com:7050 \</div><div class="line"> --tls true --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem \</div><div class="line"> --channelID mychannel --name mycc1 --peerAddresses peer0.org1.example.com:7051 \</div><div class="line"> --tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt \</div><div class="line"> --peerAddresses peer0.org2.example.com:7051 --tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt \</div><div class="line"> --version 1 --sequence 1 --init-required</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">#</span> --tls 是否启动tls</div><div class="line"><span class="meta">#</span> --ca ca证书路径</div><div class="line"><span class="meta">#</span> --channelID 智能合约安装通道</div><div class="line"><span class="meta">#</span> --name 合约名</div><div class="line"><span class="meta">#</span> --version 合约版本</div><div class="line"><span class="meta">#</span> --package-id queryinstalled查询的合约ID</div><div class="line"><span class="meta">#</span> --sequence 序列号</div><div class="line"><span class="meta">#</span> --waitForEvent 等待peer提交交易返回</div><div class="line"><span class="meta">#</span> --init-required 合约是否必须执行init</div><div class="line"><span class="meta">#</span> --peerAddresses 节点路径 </div><div class="line"><span class="meta">#</span> --tlsRootCertFiles 节点ca根证书路径(--peerAddresses --tlsRootCertFiles  连用，可多个节点，多个节点即将合约部署到对应节点集合上)</div></pre></td></tr></table></figure></p>
<p>查看docker容器会发现多了 dev-peerXXXXX容器（该容器是合约链码容器）</p>
<p>查看节点已提交合约<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">peer lifecycle chaincode querycommitted --channelID mychannel --name mycc1</div></pre></td></tr></table></figure></p>
<p>输出内容<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">approvals: &#123;</div><div class="line">    Org1MSP: true,</div><div class="line">    Org2MSP: true</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="操作合约"><a href="#操作合约" class="headerlink" title="操作合约"></a>操作合约</h4><p>fabric智能合约操作主要有invoke跟query,此处与1.x完全一致<br>初始化合约，执行init方法，设置a:100 b:100<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"> peer chaincode invoke -o orderer.example.com:7050 --tls true \</div><div class="line">--cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem \</div><div class="line">-C mychannel -n mycc1 --peerAddresses peer0.org1.example.com:7051 \</div><div class="line">--tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt \</div><div class="line">--peerAddresses peer0.org2.example.com:7051 \</div><div class="line">--tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt \</div><div class="line">--isInit -c '&#123;"Args":["Init","a","100","b","100"]&#125;'</div></pre></td></tr></table></figure></p>
<p>控制台输出：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">2020-04-20 09:18:48.685 UTC [chaincodeCmd] chaincodeInvokeOrQuery -&gt; INFO 001 Chaincode invoke successful. result: status:200</div></pre></td></tr></table></figure></p>
<p>查询a的余额<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">peer chaincode query -C mychannel -n mycc2 -c '&#123;"Args":["query","a"]&#125;'</div></pre></td></tr></table></figure></p>
<p>输出值为100</p>
<p>调用 invoke方法， a -&gt;b 转账20<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">peer chaincode invoke -o orderer.example.com:7050 --tls true \</div><div class="line">--cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem \</div><div class="line">-C mychannel -n mycc1 --peerAddresses peer0.org1.example.com:7051 \</div><div class="line">--tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt \</div><div class="line">--peerAddresses peer0.org2.example.com:7051 \</div><div class="line">--tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt  \</div><div class="line">-c  '&#123;"Args":["invoke","a","b","20"]&#125;'</div></pre></td></tr></table></figure></p>
<p>再次查询a时，输出为80</p>
<p>对应raft-4node-swarm代码已上传到git <a href="https://github.com/MisayaChad/raft-4node-swarm.git" target="_blank" rel="external">https://github.com/MisayaChad/raft-4node-swarm.git</a><br>本文档参考 <a href="https://uzshare.com/view/825034" target="_blank" rel="external">https://uzshare.com/view/825034</a> ,做了更详细的实践说明</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://misayachad.github.io/2020/05/20/超级账本 Hyperledger Fabric2.0 多机集群部署/" data-id="ckclyj7zd000lnousdka4ng3t" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-运维进程管理supervisorctl使用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/09/10/运维进程管理supervisorctl使用/" class="article-date">
  <time datetime="2018-09-10T13:13:20.000Z" itemprop="datePublished">2018-09-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Linux运维/">Linux运维</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/09/10/运维进程管理supervisorctl使用/">运维进程管理supervisorctl使用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="使用-supervisor-管理进程"><a href="#使用-supervisor-管理进程" class="headerlink" title="使用 supervisor 管理进程"></a>使用 supervisor 管理进程</h3><p>Supervisor (<a href="http://supervisord.org" target="_blank" rel="external">http://supervisord.org</a>) 是一个用 Python 写的进程管理工具，可以很方便的用来启动、重启、关闭进程（不仅仅是 Python 进程）。除了对单个进程的控制，还可以同时启动、关闭多个进程，比如很不幸的服务器出问题导致所有应用程序都被杀死，此时可以用 supervisor 同时启动所有应用程序而不是一个一个地敲命令启动。（后台启动，不会占用终端）</p>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>Supervisor 可以运行在 Linux、Mac OS X 上。如前所述，supervisor 是 Python 编写的，所以安装起来也很方便，可以直接用 pip安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo pip install supervisor</div><div class="line">如果是 Ubuntu 系统，还可以使用 apt-get 安装。</div></pre></td></tr></table></figure>
<h4 id="supervisord-配置"><a href="#supervisord-配置" class="headerlink" title="supervisord 配置"></a>supervisord 配置</h4><p>Supervisor 相当强大，提供了很丰富的功能，不过我们可能只需要用到其中一小部分。安装完成之后，可以编写配置文件，来满足自己的需求。为了方便，我们把配置分成两部分：supervisord（supervisor 是一个 C/S 模型的程序，这是 server 端，对应的有 client 端：supervisorctl）和应用程序（即我们要管理的程序）。</p>
<p>首先来看 supervisord 的配置文件。安装完 supervisor 之后，可以运行echo_supervisord_conf 命令输出默认的配置项，也可以重定向到一个配置文件里</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo_supervisord_conf &gt; /etc/supervisord.conf</div></pre></td></tr></table></figure>
<p>去除里面大部分注释和“不相关”的部分，我们可以先看这些配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">[unix_http_server]</div><div class="line">file=/tmp/supervisor.sock   ; UNIX socket 文件，supervisorctl 会使用</div><div class="line">;chmod=0700                 ; socket 文件的 mode，默认是 0700</div><div class="line">;chown=nobody:nogroup       ; socket 文件的 owner，格式： uid:gid</div><div class="line"></div><div class="line">;[inet_http_server]         ; HTTP 服务器，提供 web 管理界面</div><div class="line">;port=127.0.0.1:9001        ; Web 管理后台运行的 IP 和端口，如果开放到公网，需要注意安全性</div><div class="line">;username=user              ; 登录管理后台的用户名</div><div class="line">;password=123               ; 登录管理后台的密码</div><div class="line"></div><div class="line">[supervisord]</div><div class="line">logfile=/tmp/supervisord.log ; 日志文件，默认是 $CWD/supervisord.log</div><div class="line">logfile_maxbytes=50MB        ; 日志文件大小，超出会 rotate，默认 50MB</div><div class="line">logfile_backups=10           ; 日志文件保留备份数量默认 10</div><div class="line">loglevel=info                ; 日志级别，默认 info，其它: debug,warn,trace</div><div class="line">pidfile=/tmp/supervisord.pid ; pid 文件</div><div class="line">nodaemon=false               ; 是否在前台启动，默认是 false，即以 daemon 的方式启动</div><div class="line">minfds=1024                  ; 可以打开的文件描述符的最小值，默认 1024</div><div class="line">minprocs=200                 ; 可以打开的进程数的最小值，默认 200</div><div class="line"></div><div class="line">; the below section must remain in the config file for RPC</div><div class="line">; (supervisorctl/web interface) to work, additional interfaces may be</div><div class="line">; added by defining them in separate rpcinterface: sections</div><div class="line">[rpcinterface:supervisor]</div><div class="line">supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface</div><div class="line"></div><div class="line">[supervisorctl]</div><div class="line">serverurl=unix:///tmp/supervisor.sock ; 通过 UNIX socket 连接 supervisord，路径与 unix_http_server 部分的 file 一致</div><div class="line">;serverurl=http://127.0.0.1:9001 ; 通过 HTTP 的方式连接 supervisord</div><div class="line"></div><div class="line">; 包含其他的配置文件</div><div class="line">[include]</div><div class="line">files = relative/directory/*.ini    ; 可以是 *.conf 或 *.ini</div></pre></td></tr></table></figure>
<p>我们把上面这部分配置保存到 /etc/supervisord.conf（或其他任意有权限访问的文件），然后启动 supervisord（通过 -c 选项指定配置文件路径，如果不指定会按照这个顺序查找配置文件：$CWD/supervisord.conf, $CWD/etc/supervisord.conf, /etc/supervisord.conf）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">supervisord -c /etc/supervisord.conf</div></pre></td></tr></table></figure>
<p>查看 supervisord 是否在运行<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ps aux | grep supervisord</div></pre></td></tr></table></figure></p>
<h4 id="program-配置"><a href="#program-配置" class="headerlink" title="program 配置"></a>program 配置</h4><p>上面我们已经把 supervisrod 运行起来了，现在可以添加我们要管理的进程的配置文件。这些配置可以都写到 supervisord.conf 文件里，如果应用程序很多，最好通过 include 的方式把不同的程序（组）写到不同的配置文件里。</p>
<p>为了举例，我们新建一个目录 /etc/supervisor/ 用于存放这些配置文件，相应的，把 /etc/supervisord.conf 里 include 部分的的配置修改一下：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[include]</div><div class="line">files = /etc/supervisor/*.conf</div></pre></td></tr></table></figure></p>
<p>假设有个用 Flask 开发的用户系统 usercenter, 生产环境使用 gunicorn 运行。项目代码位于 /home/leon/projects/usercenter，WSGI 对象位于 wsgi.py。在命令行启动的方式是这样的：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd /home/leon/projects/usercenter</div><div class="line">gunicorn -w 8 -b 0.0.0.0:17510 wsgi:app</div></pre></td></tr></table></figure></p>
<p>对应的配置文件可能是：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[program:usercenter]</div><div class="line">directory = /home/leon/projects/usercenter ; 程序的启动目录</div><div class="line">command = gunicorn -w 8 -b 0.0.0.0:17510 wsgi:app  ; 启动命令</div><div class="line">autostart = true     ; 在 supervisord 启动的时候也自动启动</div><div class="line">startsecs = 5        ; 启动 5 秒后没有异常退出，就当作已经正常启动了</div><div class="line">autorestart = true   ; 程序异常退出后自动重启</div><div class="line">startretries = 3     ; 启动失败自动重试次数，默认是 3</div><div class="line">user = leon          ; 用哪个用户启动</div><div class="line">redirect_stderr = true  ; 把 stderr 重定向到 stdout，默认 false</div><div class="line">stdout_logfile_maxbytes = 20MB  ; stdout 日志文件大小，默认 50MB</div><div class="line">stdout_logfile_backups = 20     ; stdout 日志文件备份数</div><div class="line">; stdout 日志文件，需要注意当指定目录不存在时无法正常启动，所以需要手动创建目录（supervisord 会自动创建日志文件）</div><div class="line">stdout_logfile = /data/logs/usercenter_stdout.log</div></pre></td></tr></table></figure></p>
<p>其中 [program:usercenter] 中的 usercenter 是应用程序的唯一标识，不能重复。对该程序的所有操作（start, restart 等）都通过名字来实现。</p>
<h4 id="使用-supervisorctl"><a href="#使用-supervisorctl" class="headerlink" title="使用 supervisorctl"></a>使用 supervisorctl</h4><p>Supervisorctl 是 supervisord 的一个命令行客户端工具，启动时需要指定与 supervisord 使用同一份配置文件，否则与 supervisord 一样按照顺序查找配置文件。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">supervisorctl -c /etc/supervisord.conf</div></pre></td></tr></table></figure></p>
<p>上面这个命令会进入 supervisorctl 的 shell 界面，然后可以执行不同的命令了：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span> status    # 查看程序状态</div><div class="line"><span class="meta">&gt;</span> stop usercenter   # 关闭 usercenter 程序</div><div class="line"><span class="meta">&gt;</span> start usercenter  # 启动 usercenter 程序</div><div class="line"><span class="meta">&gt;</span> restart usercenter    # 重启 usercenter 程序</div><div class="line"><span class="meta">&gt;</span> reread    ＃ 读取有更新（增加）的配置文件，不会启动新添加的程序</div><div class="line"><span class="meta">&gt;</span> update    ＃ 重启配置文件修改过的程序</div></pre></td></tr></table></figure></p>
<p>上面这些命令都有相应的输出，除了进入 supervisorctl 的 shell 界面，也可以直接在 bash 终端运行：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> supervisorctl status</div><div class="line"><span class="meta">$</span> supervisorctl stop usercenter</div><div class="line"><span class="meta">$</span> supervisorctl start usercenter</div><div class="line"><span class="meta">$</span> supervisorctl restart usercenter</div><div class="line"><span class="meta">$</span> supervisorctl reread</div><div class="line"><span class="meta">$</span> supervisorctl update</div></pre></td></tr></table></figure></p>
<p>refrence: <a href="http://supervisord.org/index.html" target="_blank" rel="external">http://supervisord.org/index.html</a></p>
<p>公司实例supervisor config：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div></pre></td><td class="code"><pre><div class="line">; Sample supervisor config file.</div><div class="line">;</div><div class="line">; For more information on the config file, please see:</div><div class="line">; http://supervisord.org/configuration.html</div><div class="line">;</div><div class="line">; Notes:</div><div class="line">;  - Shell expansion ("~" or "$HOME") is not supported.  Environment</div><div class="line">;    variables can be expanded using this syntax: "%(ENV_HOME)s".</div><div class="line">;  - Comments must have a leading space: "a=b ;comment" not "a=b;comment".</div><div class="line"></div><div class="line">[unix_http_server]</div><div class="line">file=/tmp/supervisor.sock   ; (the path to the socket file)</div><div class="line">;chmod=0700                 ; socket file mode (default 0700)</div><div class="line">;chown=nobody:nogroup       ; socket file uid:gid owner</div><div class="line">;username=user              ; (default is no username (open server))</div><div class="line">;password=123               ; (default is no password (open server))</div><div class="line"></div><div class="line">;[inet_http_server]         ; inet (TCP) server disabled by default</div><div class="line">;port=127.0.0.1:9001        ; (ip_address:port specifier, *:port for all iface)</div><div class="line">;username=user              ; (default is no username (open server))</div><div class="line">;password=123               ; (default is no password (open server))</div><div class="line"></div><div class="line">[supervisord]</div><div class="line">logfile=/tmp/supervisord.log ; (main log file;default $CWD/supervisord.log)</div><div class="line">logfile_maxbytes=50MB        ; (max main logfile bytes b4 rotation;default 50MB)</div><div class="line">logfile_backups=10           ; (num of main logfile rotation backups;default 10)</div><div class="line">loglevel=info                ; (log level;default info; others: debug,warn,trace)</div><div class="line">pidfile=/tmp/supervisord.pid ; (supervisord pidfile;default supervisord.pid)</div><div class="line">nodaemon=false               ; (start in foreground if true;default false)</div><div class="line">minfds=1024                  ; (min. avail startup file descriptors;default 1024)</div><div class="line">minprocs=200                 ; (min. avail process descriptors;default 200)</div><div class="line">;umask=022                   ; (process file creation umask;default 022)</div><div class="line">;user=chrism                 ; (default is current user, required if root)</div><div class="line">;identifier=supervisor       ; (supervisord identifier, default is 'supervisor')</div><div class="line">;directory=/tmp              ; (default is not to cd during start)</div><div class="line">;nocleanup=true              ; (don't clean up tempfiles at start;default false)</div><div class="line">;childlogdir=/tmp            ; ('AUTO' child log dir, default $TEMP)</div><div class="line">;environment=KEY="value"     ; (key value pairs to add to environment)</div><div class="line">;strip_ansi=false            ; (strip ansi escape codes in logs; def. false)</div><div class="line"></div><div class="line">; the below section must remain in the config file for RPC</div><div class="line">; (supervisorctl/web interface) to work, additional interfaces may be</div><div class="line">; added by defining them in separate rpcinterface: sections</div><div class="line">[rpcinterface:supervisor]</div><div class="line">supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface</div><div class="line"></div><div class="line">[supervisorctl]</div><div class="line">serverurl=unix:///tmp/supervisor.sock ; use a unix:// URL  for a unix socket</div><div class="line">;serverurl=http://127.0.0.1:9001 ; use an http:// url to specify an inet socket</div><div class="line">;username=chris              ; should be same as http_username if set</div><div class="line">;password=123                ; should be same as http_password if set</div><div class="line">;prompt=mysupervisor         ; cmd line prompt (default "supervisor")</div><div class="line">;history_file=~/.sc_history  ; use readline history if available</div><div class="line"></div><div class="line">; The below sample program section shows all possible program subsection values,</div><div class="line">; create one or more 'real' program: sections to be able to control them under</div><div class="line">; supervisor.</div><div class="line"></div><div class="line">;[program:theprogramname]</div><div class="line">;command=/bin/cat              ; the program (relative uses PATH, can take args)</div><div class="line">;process_name=%(program_name)s ; process_name expr (default %(program_name)s)</div><div class="line">;numprocs=1                    ; number of processes copies to start (def 1)</div><div class="line">;directory=/tmp                ; directory to cwd to before exec (def no cwd)</div><div class="line">;umask=022                     ; umask for process (default None)</div><div class="line">;priority=999                  ; the relative start priority (default 999)</div><div class="line">;autostart=true                ; start at supervisord start (default: true)</div><div class="line">;startsecs=1                   ; # of secs prog must stay up to be running (def. 1)</div><div class="line">;startretries=3                ; max # of serial start failures when starting (default 3)</div><div class="line">;autorestart=unexpected        ; when to restart if exited after running (def: unexpected)</div><div class="line">;exitcodes=0,2                 ; 'expected' exit codes used with autorestart (default 0,2)</div><div class="line">;stopsignal=QUIT               ; signal used to kill process (default TERM)</div><div class="line">;stopwaitsecs=10               ; max num secs to wait b4 SIGKILL (default 10)</div><div class="line">;stopasgroup=false             ; send stop signal to the UNIX process group (default false)</div><div class="line">;killasgroup=false             ; SIGKILL the UNIX process group (def false)</div><div class="line">;user=chrism                   ; setuid to this UNIX account to run the program</div><div class="line">;redirect_stderr=true          ; redirect proc stderr to stdout (default false)</div><div class="line">;stdout_logfile=/a/path        ; stdout log path, NONE for none; default AUTO</div><div class="line">;stdout_logfile_maxbytes=1MB   ; max # logfile bytes b4 rotation (default 50MB)</div><div class="line">;stdout_logfile_backups=10     ; # of stdout logfile backups (default 10)</div><div class="line">;stdout_capture_maxbytes=1MB   ; number of bytes in 'capturemode' (default 0)</div><div class="line">;stdout_events_enabled=false   ; emit events on stdout writes (default false)</div><div class="line">;stderr_logfile=/a/path        ; stderr log path, NONE for none; default AUTO</div><div class="line">;stderr_logfile_maxbytes=1MB   ; max # logfile bytes b4 rotation (default 50MB)</div><div class="line">;stderr_logfile_backups=10     ; # of stderr logfile backups (default 10)</div><div class="line">;stderr_capture_maxbytes=1MB   ; number of bytes in 'capturemode' (default 0)</div><div class="line">;stderr_events_enabled=false   ; emit events on stderr writes (default false)</div><div class="line">;environment=A="1",B="2"       ; process environment additions (def no adds)</div><div class="line">;serverurl=AUTO                ; override serverurl computation (childutils)</div><div class="line"></div><div class="line">; The below sample eventlistener section shows all possible</div><div class="line">; eventlistener subsection values, create one or more 'real'</div><div class="line">; eventlistener: sections to be able to handle event notifications</div><div class="line">; sent by supervisor.</div><div class="line"></div><div class="line">;[eventlistener:theeventlistenername]</div><div class="line">;command=/bin/eventlistener    ; the program (relative uses PATH, can take args)</div><div class="line">;process_name=%(program_name)s ; process_name expr (default %(program_name)s)</div><div class="line">;numprocs=1                    ; number of processes copies to start (def 1)</div><div class="line">;events=EVENT                  ; event notif. types to subscribe to (req'd)</div><div class="line">;buffer_size=10                ; event buffer queue size (default 10)</div><div class="line">;directory=/tmp                ; directory to cwd to before exec (def no cwd)</div><div class="line">;umask=022                     ; umask for process (default None)</div><div class="line">;priority=-1                   ; the relative start priority (default -1)</div><div class="line">;autostart=true                ; start at supervisord start (default: true)</div><div class="line">;startsecs=1                   ; # of secs prog must stay up to be running (def. 1)</div><div class="line">;startretries=3                ; max # of serial start failures when starting (default 3)</div><div class="line">;autorestart=unexpected        ; autorestart if exited after running (def: unexpected)</div><div class="line">;exitcodes=0,2                 ; 'expected' exit codes used with autorestart (default 0,2)</div><div class="line">;stopsignal=QUIT               ; signal used to kill process (default TERM)</div><div class="line">;stopwaitsecs=10               ; max num secs to wait b4 SIGKILL (default 10)</div><div class="line">;stopasgroup=false             ; send stop signal to the UNIX process group (default false)</div><div class="line">;killasgroup=false             ; SIGKILL the UNIX process group (def false)</div><div class="line">;user=chrism                   ; setuid to this UNIX account to run the program</div><div class="line">;redirect_stderr=false         ; redirect_stderr=true is not allowed for eventlisteners</div><div class="line">;stdout_logfile=/a/path        ; stdout log path, NONE for none; default AUTO</div><div class="line">;stdout_logfile_maxbytes=1MB   ; max # logfile bytes b4 rotation (default 50MB)</div><div class="line">;stdout_logfile_backups=10     ; # of stdout logfile backups (default 10)</div><div class="line">;stdout_events_enabled=false   ; emit events on stdout writes (default false)</div><div class="line">;stderr_logfile=/a/path        ; stderr log path, NONE for none; default AUTO</div><div class="line">;stderr_logfile_maxbytes=1MB   ; max # logfile bytes b4 rotation (default 50MB)</div><div class="line">;stderr_logfile_backups=10     ; # of stderr logfile backups (default 10)</div><div class="line">;stderr_events_enabled=false   ; emit events on stderr writes (default false)</div><div class="line">;environment=A="1",B="2"       ; process environment additions</div><div class="line">;serverurl=AUTO                ; override serverurl computation (childutils)</div><div class="line"></div><div class="line">; The below sample group section shows all possible group values,</div><div class="line">; create one or more 'real' group: sections to create "heterogeneous"</div><div class="line">; process groups.</div><div class="line"></div><div class="line">;[group:thegroupname]</div><div class="line">;programs=progname1,progname2  ; each refers to 'x' in [program:x] definitions</div><div class="line">;priority=999                  ; the relative start priority (default 999)</div><div class="line"></div><div class="line">; The [include] section can just contain the "files" setting.  This</div><div class="line">; setting can list multiple files (separated by whitespace or</div><div class="line">; newlines).  It can also contain wildcards.  The filenames are</div><div class="line">; interpreted as relative to this file.  Included files *cannot*</div><div class="line">; include files themselves.</div><div class="line"></div><div class="line">;[include]</div><div class="line">;files = relative/directory/*.ini</div><div class="line"></div><div class="line">[program:listener]</div><div class="line">command=/opt/gopath/listener start -c /opt/gopath/service.yaml</div><div class="line">[program:rewarder]</div><div class="line">command=/opt/gopath/rewarder start -c /opt/gopath/service-rewarder.yaml</div><div class="line">[program:ai]</div><div class="line">command=python /opt/CNN-Classifier/manage.py runserver 0.0.0.0:8000</div></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://misayachad.github.io/2018/09/10/运维进程管理supervisorctl使用/" data-id="ckclyj7zf000mnousrk9umu6u" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-问题" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/08/01/问题/" class="article-date">
  <time datetime="2018-08-01T11:33:30.000Z" itemprop="datePublished">2018-08-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/宝典/">宝典</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/08/01/问题/">问题</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Java题</p>
<p>MyBatis和Hibernate的区别及应用场景？<br>都是orm框架<br>MyBatis：更轻量级，对于复杂的sql查询更好，基于sql<br>Hibernate： 重量级，移植性好不依赖于sql，拥有更好的缓存机制、支持第三方缓存</p>
<p>Redis存储和数据库存储的区别？<br>Redis：是一个内存数据库，存储位置在内存，内存访问相比硬盘更快，可存储的数据类型更丰富，可持久化，数据量小使用Redis存储比Memcached存储性能好<br>Memcached：存储位置在内存，支持key-value存储，单次数据量大于10k性能比Redis存储好<br>传统数据库（mysql、pg）： 存储位置在硬盘</p>
<p>Android四大组件？深入理解</p>
<p>MVC、MVP、MVVM优缺点及比较</p>
<p>Android线程间通信？<br>Handler<br>runOnUiThread<br>AsyncTask<br>View.post</p>
<p>Android PopupWindow 部分机型（魅族）点击外部不能取消的bug<br>解决办法：<br>在showAs之前设置setBackgroundDrawable(new BitmapDrawable());</p>
<p>Android内存泄漏场景？<br>做app升级时需调用DownloadMannger Cursor查下载进度，部分手机在查询过程中需要关闭Cursor<br>使用WebView显示网页，在WebView需要销毁时，先让WebView显示null，然后删除WebView，最后销毁WebView</p>
<p>Universal-Image-Loader工作流程？<br>下载图片——将图片缓存在磁盘中——解码图片成为Bitmap——Bitmap的预处理——缓存在Bitmap内存中——Bitmap的后期处理——显示Bitmap</p>
<p>Volley原理及流程？<br><img src="/images/volley原理及流程.jpg" alt=""><br>使用建造者模式、工厂、单例</p>
<p>OKHttp原理？</p>
<ol>
<li>OkhttpClient 实现了Call.Fctory,负责为Request 创建 Call；</li>
<li>RealCall 为Call的具体实现，其enqueue() 异步请求接口通过Dispatcher()调度器利用ExcutorService实现，而最终进行网络请求时和同步的execute()接口一致，都是通过 getResponseWithInterceptorChain() 函数实现</li>
<li>getResponseWithInterceptorChain() 中利用 Interceptor 链条，责任链模式 分层实现缓存、透明压缩、网络 IO 等功能；最终将响应数据返回给用户</li>
</ol>
<p>Retrofit原理？<br><img src="/images/Retrofit工作流程原理图.jpg" alt=""><br>Retrofit对网络请求参数的封装，OKHttp才是真正的网络请求<br>Retrofit2.0 内置OKHttp<br>Retrofit采用了外观模式统一调用创建网络请求接口实例和网络请求参数配置的方法，具体细节是：<br>动态创建网络请求接口的实例（代理模式 - 动态代理）<br>创建 serviceMethod 对象（建造者模式 &amp; 单例模式（缓存机制））<br>对 serviceMethod 对象进行网络请求参数配置：通过解析网络请求接口方法的参数、返回值和注解类型，从Retrofit对象中获取对应的网络请求的url地址、网络请求执行器、网络请求适配器 &amp; 数据转换器。（RxjavaCallAdapter使用的是策略模式）<br>对 serviceMethod 对象加入线程切换的操作，便于接收数据后通过Handler从子线程切换到主线程从而对返回数据结果进行处理（装饰模式）<br>最终创建并返回一个OkHttpCall类型的网络请求对象</p>
<p>HTTPS原理？<br>HTTPS是在HTTP请求基础上增加安全加密传输的协议，增加CA证书用于效验安全性<br>Andoird 4.4以下系统未开启HTTPS TLS1.1和TLS1.2协议的支持<br>https单向验证流程<br><img src="/images/https单向验证流程.jpg" alt=""><br>https双向验证流程<br><img src="/images/https双向验证流程.jpg" alt=""><br>refrence: <a href="https://zhuanlan.zhihu.com/p/27040041?utm_medium=social&amp;utm_source=weibo" target="_blank" rel="external">https://zhuanlan.zhihu.com/p/27040041?utm_medium=social&amp;utm_source=weibo</a></p>
<p>Socket原理？</p>
<p>android studio3.0 的bulid gradle中就出现了api 和implementation区别<br>api和implementation 替代了compile<br>api 提供外部依赖访问<br>implementation 只能在内部依赖使用库</p>
<p>Binder机制及原理？</p>
<p>屏幕适配？</p>
<p>orm框架的使用？GreenDao、Room、ormLite区别及原理？<br>ormLite：采用反射的方式生成sql，造成性能损耗，慢<br>GreenDao：支持数据库加密，和原生sqlite类似，较快<br>Room：采用注解，编译时检测sql语句，更快，支持livedata<br>refrence: <a href="http://andyken.github.io/2017/10/26/Android%E6%B5%81%E8%A1%8CORM%E6%A1%86%E6%9E%B6%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94%E5%8F%8ARoom%E8%B8%A9%E5%9D%91%E6%80%BB%E7%BB%93/" target="_blank" rel="external">http://andyken.github.io/2017/10/26/Android%E6%B5%81%E8%A1%8CORM%E6%A1%86%E6%9E%B6%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94%E5%8F%8ARoom%E8%B8%A9%E5%9D%91%E6%80%BB%E7%BB%93/</a></p>
<p>dagger2、butterknife区别？<br>dagger2、butterknife两者都是依赖注入，预编译注解<br>butterknife只能用于视图之间的绑定，替代findViewByid<br>dagger2可以在moudel中注入任意(视图、类、接口)<br>预编译注解比运行时注解性能好，应为运行时注解采用了反射消耗了性能</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://misayachad.github.io/2018/08/01/问题/" data-id="ckclyj7zg000pnous18w7ss92" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Android刘海屏适配" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/06/10/Android刘海屏适配/" class="article-date">
  <time datetime="2018-06-10T12:13:20.000Z" itemprop="datePublished">2018-06-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/06/10/Android刘海屏适配/">Android刘海屏适配</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://misayachad.github.io/2018/06/10/Android刘海屏适配/" data-id="ckclyj7z10004nousbylp8s4x" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Java消息服务" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/05/10/Java消息服务/" class="article-date">
  <time datetime="2018-05-10T13:00:11.000Z" itemprop="datePublished">2018-05-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/JavaEE/">JavaEE</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/05/10/Java消息服务/">Java消息服务</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="消息服务"><a href="#消息服务" class="headerlink" title="消息服务"></a>消息服务</h3><p>消息服务指的是两个应用程序之间进行异步通信的API，它为标准消息协议和消息服务提供了一组通用接口，包括创建、发送、读取消息等</p>
<h4 id="JMS消息传送模型"><a href="#JMS消息传送模型" class="headerlink" title="JMS消息传送模型"></a>JMS消息传送模型</h4><p>在JMS API出现之前，大部分产品使用“点对点”和“发布/订阅”中的任一方式来进行消息通讯。JMS定义了这两种消息发送模型的规范，它们相互独立。任何JMS的提供者可以实现其中的一种或两种模型，这是它们自己的选择。JMS规范提供了通用接口保证我们基于JMS API编写的程序适用于任何一种模型。</p>
<h5 id="点对点消息传送模型"><a href="#点对点消息传送模型" class="headerlink" title="点对点消息传送模型"></a>点对点消息传送模型</h5><p>　　在点对点消息传送模型中，应用程序由消息队列，发送者，接收者组成。每一个消息发送给一个特殊的消息队列，该队列保存了所有发送给它的消息(除了被接收者消费掉的和过期的消息)。点对点消息模型有一些特性，如下：</p>
<p>每个消息只有一个接收者；<br>消息发送者和接收者并没有时间依赖性；<br>当消息发送者发送消息的时候，无论接收者程序在不在运行，都能获取到消息；<br>当接收者收到消息的时候，会发送确认收到通知（acknowledgement）。</p>
<p><img src="/images/jms点对点消息传送模型.jpg" alt=""></p>
<h5 id="发布-订阅消息传递模型"><a href="#发布-订阅消息传递模型" class="headerlink" title="发布/订阅消息传递模型"></a>发布/订阅消息传递模型</h5><p>　　在发布/订阅消息模型中，发布者发布一个消息，该消息通过topic传递给所有的客户端。在这种模型中，发布者和订阅者彼此不知道对方，是匿名的且可以动态发布和订阅topic。topic主要用于保存和传递消息，且会一直保存消息直到消息被传递给客户端。</p>
<p>发布/订阅消息模型特性如下：</p>
<p>一个消息可以传递给多个订阅者<br>发布者和订阅者有时间依赖性，只有当客户端创建订阅后才能接受消息，且订阅者需一直保持活动状态以接收消息。<br>为了缓和这样严格的时间相关性，JMS允许订阅者创建一个可持久化的订阅。这样，即使订阅者没有被激活（运行），它也能接收到发布者的消息。</p>
<p><img src="/images/jms发布/订阅消息传递模型.jpg" alt=""></p>
<h3 id="RMI、RPC和JMS的比较"><a href="#RMI、RPC和JMS的比较" class="headerlink" title="RMI、RPC和JMS的比较"></a>RMI、RPC和JMS的比较</h3><h4 id="RMI"><a href="#RMI" class="headerlink" title="RMI"></a>RMI</h4><p>Java RMI 指的是远程方法调用 (Remote MethodInvocation)。它是一种机制，能够让在某个 Java 虚拟机上的对象调用另一个 Java虚拟机中的对象上的方法。可以用此方法调用的任何对象必须实现该远程接口。</p>
<p>RMI对服务器的IP地址和端口依赖很紧密，但是在开发的时候不知道将来的服务器IP和端口如何，但是客户端程序依赖这个IP和端口。这也是RMI的局限性之一。这个问题有两种解决途径：一是通过DNS来解决，二是通过封装将IP暴露到程序代码之外。RMI的局限性之二是RMI是Java语言的远程调用，两端的程序语言必须是Java实现，对于不同语言间的通讯可以考虑用WebService或者公用对象请求代理体系（CORBA）来实现。<br>       使用代表：EJB</p>
<p>===============================================================================================================</p>
<h4 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a>RPC</h4><p>RPC（Remote ProcedureCall Protocol）——远程过程调用协议，它是一种通过网络从远程计算机程序上请求服务，而不需要了解底层网络技术的协议。RPC协议假定某些传输协议的存在，如TCP或UDP，为通信程序之间携带信息数据。在OSI网络通信模型中，RPC跨越了传输层和应用层。RPC使得开发包括网络分布式多程序在内的应用程序更加容易。<br>        使用代表：Dubbo</p>
<p>===============================================================================================================</p>
<h4 id="JMS"><a href="#JMS" class="headerlink" title="JMS"></a>JMS</h4><p>Java 消息服务 (Java Messaging Service, JMS ) 是一种允许应用程序创建、发送、接受和读取消息的Java API 。JMS 在其中扮演的角色与JDBC 很相似，正如JDBC 提供了一套用于访问各种不同关系数据库的公共API，JMS 也提供了独立于特定厂商的企业消息系统访问方式。<br>使用JMS 的应用程序被称为JMS 客户端，处理消息路由与传递的消息系统被称为JMS Provider，而JMS 应用则是由多个JMS 客户端和一个JMSProvider 构成的业务系统。发送消息的JMS 客户端被称为生产者（producer），而接收消息的JMS 客户端则被称为消费者(consumer)。同一JMS 客户端既可以是生产者也可以是消费者。<br>JMS 的编程过程很简单，概括为：应用程序A 发送一条消息到消息服务器（也就是JMS Provider）的某个目得地(Destination)，然后消息服务器把消息转发给应用程序B。因为应用程序A 和应用程序B 没有直接的代码关连，所以两者实现了解偶。</p>
<p>===============================================================================================================</p>
<h4 id="RMI和RPC"><a href="#RMI和RPC" class="headerlink" title="RMI和RPC"></a>RMI和RPC</h4><p>1.返回值上：RMI 调用远程对象方法，允许方法返回 Java 对象以及基本数据类型。而 RPC 不支持对象的概念，传送到 RPC 服务的消息由外部数据表示 (ExternalData Representation,XDR) 语言表示，这种语言抽象了字节序类和数据类型结构之间的差异。只有由 XDR 定义的数据类型才能被传递， RPC 不允许传递对象。可以说 RMI 是面向对象方式的 JavaRPC 。<br>2.通信语言<br>RMI：仅支持Java语言<br>RPC：可以跨语言访问<br>3.错误处理不支持对象，无法在编译器检查错误，只能在运行期检查。<br>4.方法调用<br>在方法调用上，RMI中，远程接口使每个远程方法都具有方法签名。如果一个方法在服务器上执行，但是没有相匹配的签名被添加到这个远程接口上，那么这个新方法就不能被RMI客户方所调用。<br>在RPC中，当一个请求到达RPC服务器时，这个请求就包含了一个参数集和一个文本值，通常形成“classname.methodname”的形式。这就向RPC服务器表明，被请求的方法在为“classname”的类中，名叫“methodname”。然后RPC服务器就去搜索与之相匹配的类和方法，并把它作为那种方法参数类型的输入。这里的参数类型是与RPC请求中的类型是匹配的。一旦匹配成功，这个方法就被调用了，其结果被编码后返回客户方。</p>
<p>===============================================================================================================</p>
<h4 id="RMI和JMS"><a href="#RMI和JMS" class="headerlink" title="RMI和JMS"></a>RMI和JMS</h4><p>1.传输方式上</p>
<pre><code>JMS 与 RMI 的区别在于，采用 JMS 服务，对象是在物理上被异步从网络的某个 JVM 上直接移动到另一个 JVM 上。RMI 对象是绑定在本地 JVM 中，只有函数参数和返回值是通过网络传送的。
</code></pre><p>2.方法调用上</p>
<pre><code>RMI一般都是同步的，也就是说，当client调用Server的一个方法的时候，需要等到对方的返回，才能继续执行client端，这个过程调用本地方法感觉上是一样的，这也是RMI的一个特点。JMS 一般只是一个点发出一个Message到Message Server,发出之后一般不会关心谁用了这个message。一般RMI的应用是紧耦合，JMS的应用相对来说是松散耦合应用。
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://misayachad.github.io/2018/05/10/Java消息服务/" data-id="ckclyj7z50009noussmrd6plw" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Android实时监听网络状态" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/10/26/Android实时监听网络状态/" class="article-date">
  <time datetime="2017-10-26T06:23:16.000Z" itemprop="datePublished">2017-10-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/10/26/Android实时监听网络状态/">Android实时监听网络状态</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>先简单说一下思路：网络变化时系统会发出广播。所以我们监听这个广播，利用接口回调通知activity做相应的操作就好了。。<br>步骤：<br>1、写个判断网络的工具类.<br>2、先写个类继承BroadcastReceiver。（不要忘记在清单文件中注册）<br>需要在清单文件中添加权限<br>3、写个回调接口<br>4、BaseActivity实现这个接口<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> Chad 判断网络工具类</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NetUtil</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 没有连接网络</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NETWORK_NONE = -<span class="number">1</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 移动网络</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NETWORK_MOBILE = <span class="number">0</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 无线网络</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NETWORK_WIFI = <span class="number">1</span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getNetWorkState</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="comment">// 得到连接管理器对象</span></div><div class="line">        ConnectivityManager connectivityManager = (ConnectivityManager) context</div><div class="line">                .getSystemService(Context.CONNECTIVITY_SERVICE);</div><div class="line">        NetworkInfo activeNetworkInfo = connectivityManager</div><div class="line">                .getActiveNetworkInfo();</div><div class="line">        <span class="keyword">if</span> (activeNetworkInfo != <span class="keyword">null</span> &amp;&amp; activeNetworkInfo.isConnected()) &#123;</div><div class="line">            <span class="keyword">if</span> (activeNetworkInfo.getType() == (ConnectivityManager.TYPE_WIFI)) &#123;</div><div class="line">                <span class="keyword">return</span> NETWORK_WIFI;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (activeNetworkInfo.getType() == (ConnectivityManager.TYPE_MOBILE)) &#123;</div><div class="line">                <span class="keyword">return</span> NETWORK_MOBILE;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> NETWORK_NONE;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> NETWORK_NONE;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 自定义检查手机网络状态是否切换的广播接受器</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> Chad</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NetBroadcastReceiver</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> NetEvevt evevt = BaseActivity.evevt;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</div><div class="line">        <span class="comment">// TODO Auto-generated method stub</span></div><div class="line">        <span class="comment">// 如果相等的话就说明网络状态发生了变化</span></div><div class="line">        <span class="keyword">if</span> (intent.getAction().equals(ConnectivityManager.CONNECTIVITY_ACTION)) &#123;</div><div class="line">            <span class="keyword">int</span> netWorkState = NetUtil.getNetWorkState(context);</div><div class="line">            <span class="comment">// 接口回调传过去状态的类型</span></div><div class="line">            evevt.onNetChange(netWorkState);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 自定义接口</span></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">NetEvevt</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNetChange</span><span class="params">(<span class="keyword">int</span> netMobile)</span></span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">记得在manifest中注册</div><div class="line">&lt;receiver android:name=<span class="string">"cn.broadcastreceiver.NetBroadcastReceiver"</span> &gt;</div><div class="line">            &lt;intent-filter&gt;</div><div class="line">                &lt;action android:name=<span class="string">"android.net.conn.CONNECTIVITY_CHANGE"</span> /&gt;</div><div class="line">            &lt;/intent-filter&gt;</div><div class="line">        &lt;/receiver&gt;</div><div class="line"><span class="keyword">abstract</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseActivity</span> <span class="keyword">extends</span> <span class="title">FragmentActivity</span> <span class="keyword">implements</span> <span class="title">NetEvevt</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> NetEvevt evevt;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 网络类型</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> netMobile;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle arg0)</span> </span>&#123;</div><div class="line">        <span class="comment">// TODO Auto-generated method stub</span></div><div class="line">        <span class="keyword">super</span>.onCreate(arg0);</div><div class="line">        evevt = <span class="keyword">this</span>;</div><div class="line">        inspectNet();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 初始化时判断有没有网络</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">inspectNet</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.netMobile = NetUtil.getNetWorkState(BaseActivity.<span class="keyword">this</span>);</div><div class="line">        <span class="keyword">return</span> isNetConnect();</div><div class="line">        <span class="comment">// if (netMobile == 1) &#123;</span></div><div class="line">        <span class="comment">// System.out.println("inspectNet：连接wifi");</span></div><div class="line">        <span class="comment">// &#125; else if (netMobile == 0) &#123;</span></div><div class="line">        <span class="comment">// System.out.println("inspectNet:连接移动数据");</span></div><div class="line">        <span class="comment">// &#125; else if (netMobile == -1) &#123;</span></div><div class="line">        <span class="comment">// System.out.println("inspectNet:当前没有网络");</span></div><div class="line">        <span class="comment">//</span></div><div class="line">        <span class="comment">// &#125;</span></div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 网络变化之后的类型</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNetChange</span><span class="params">(<span class="keyword">int</span> netMobile)</span> </span>&#123;</div><div class="line">        <span class="comment">// TODO Auto-generated method stub</span></div><div class="line">        <span class="keyword">this</span>.netMobile = netMobile;</div><div class="line">        isNetConnect();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 判断有无网络 。</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> true 有网, false 没有网络.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isNetConnect</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (netMobile == <span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (netMobile == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (netMobile == -<span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        &#125;</div><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNetChange</span><span class="params">(<span class="keyword">int</span> netMobile)</span> </span>&#123;</div><div class="line">        <span class="comment">// TODO Auto-generated method stub</span></div><div class="line">        <span class="comment">//在这个判断，根据需要做处理</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://misayachad.github.io/2017/10/26/Android实时监听网络状态/" data-id="ckclyj7yx0001nouscn9hrlt3" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Android-Rx风格" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/10/12/Android-Rx风格/" class="article-date">
  <time datetime="2017-10-12T02:35:38.000Z" itemprop="datePublished">2017-10-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/10/12/Android-Rx风格/">Android Rx风格</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Rx代码风格<br>解决Android线程间切换、嵌套请求造成代码臃肿<br>map：请求接口转化成想要的类型<br>flatmap：请求完一个接口，继续请求下一个接口</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://misayachad.github.io/2017/10/12/Android-Rx风格/" data-id="ckclyj7yu0000nous2rystghz" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-RecyclerView和ListView使用对比分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/25/RecyclerView和ListView使用对比分析/" class="article-date">
  <time datetime="2017-09-25T10:33:16.000Z" itemprop="datePublished">2017-09-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/25/RecyclerView和ListView使用对比分析/">RecyclerView和ListView使用对比分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>RecyclerView优点</p>
<ol>
<li>设置布局管理器可成为 线性布局、网格布局（GridView）、瀑布流布局</li>
<li>自带动画效果，也可自定义动画</li>
<li>自带局部更新</li>
<li>支持嵌套滚动机制</li>
</ol>
<p>ListView优点</p>
<ol>
<li>空数据处理 setEmptyView处理Adapter中数据为空的情况</li>
<li>头布局和脚布局提供api直接添加</li>
<li>拥有条目事件监听 onItemClickListener</li>
</ol>
<p>性能分析：RecyclerView复用控件拥有更多缓存机制（4级缓存优化）<br>        ListView复用控件拥有2级缓存</p>
<p>目前使用BaseRecyclerViewAdapterHelper第三方开源库拥有ListView优点</p>
<p>refrence: <a href="https://www.jianshu.com/p/f592f3715ae2" target="_blank" rel="external">https://www.jianshu.com/p/f592f3715ae2</a><br>&emsp;&emsp;&emsp;&emsp;&ensp;&ensp; <a href="https://zhuanlan.zhihu.com/p/23339185" target="_blank" rel="external">https://zhuanlan.zhihu.com/p/23339185</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://misayachad.github.io/2017/09/25/RecyclerView和ListView使用对比分析/" data-id="ckclyj7za000enouse58aqilg" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Umeng消息的完全自定义处理" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/04/Umeng消息的完全自定义处理/" class="article-date">
  <time datetime="2017-09-04T06:23:16.000Z" itemprop="datePublished">2017-09-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/04/Umeng消息的完全自定义处理/">Umeng消息的完全自定义处理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>1，下面的前提是必须申请了友盟且有app key<br>2，集成友盟SDK  参看官方文档<a href="http://dev.umeng.com/push/android/integration#1" target="_blank" rel="external">http://dev.umeng.com/push/android/integration#1</a><br>3，若开发者需要实现对消息的完全自定义处理，则可以继承 UmengBaseIntentService, 实现自己的Service来完全控制达到消息的处理。<br>    1,实现一个类，继承 UmengBaseIntentService， 重写onMessage(Context context, Intent intent) 方法，并请调用super.onMessage(context, intent)。参考 demo 应用中MyPushIntentService。请参考下面代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 友盟推送服务</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PushIntentService</span> <span class="keyword">extends</span> <span class="title">UmengBaseIntentService</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = PushIntentService.class.getName();</div><div class="line"></div><div class="line"><span class="comment">// 如果需要打开Activity，请调用Intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)；否则无法打开Activity。</span></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</div><div class="line">        <span class="comment">// 需要调用父类的函数，否则无法统计到消息送达</span></div><div class="line">        <span class="keyword">super</span>.onMessage(context, intent);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">//可以通过MESSAGE_BODY取得消息体</span></div><div class="line">            String message = intent.getStringExtra(BaseConstants.MESSAGE_BODY);</div><div class="line"><span class="comment">//            String str=message.replaceAll("\\\\", "");//将URL中的反斜杠替换为空  加上之后收不到消息</span></div><div class="line">            UMessage msg = <span class="keyword">new</span> UMessage(<span class="keyword">new</span> JSONObject(message));</div><div class="line">            Log.d(TAG,<span class="string">"message="</span> + message);    <span class="comment">//消息体</span></div><div class="line">            Log.d(TAG, <span class="string">"custom="</span> + msg.custom);    <span class="comment">//自定义消息的内容</span></div><div class="line">            Log.d(TAG, <span class="string">"title="</span> + msg.title);    <span class="comment">//通知标题</span></div><div class="line">            Log.d(TAG, <span class="string">"text="</span> + msg.text);    <span class="comment">//通知内容</span></div><div class="line">            <span class="comment">//消息处理</span></div><div class="line">            Map&lt;String ,String&gt; extra=msg.extra;</div><div class="line">            String displayType=extra.get(<span class="string">"displayType"</span>);<span class="comment">//展示情况WAP 和直接activity展示</span></div><div class="line">            Intent intentAct = <span class="keyword">new</span> Intent();</div><div class="line">            intentAct.setClass(context, MessageDetailActivity.class);</div><div class="line">            intentAct.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</div><div class="line">            Bundle bundle = <span class="keyword">new</span> Bundle();</div><div class="line">            MessageItem item=<span class="keyword">new</span> MessageItem();<span class="comment">//自定义的消息bean</span></div><div class="line">            item.setMsmType(<span class="string">"PUSH"</span>);</div><div class="line">            item.setMsmcontent(msg.text);<span class="comment">//获取推送的消息内容</span></div><div class="line">            item.setTitle(msg.title);<span class="comment">//获取推送的消息标题</span></div><div class="line">            <span class="keyword">if</span> (displayType.equals(<span class="string">"DISPLAYONAPP"</span>))&#123;<span class="comment">//手机端展示</span></div><div class="line">                item.setDisplayType(<span class="string">"DISPLAYONAPP"</span>);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (displayType.equals(<span class="string">"DISPLAYONWAP"</span>))&#123;<span class="comment">//打开指定网页</span></div><div class="line">                item.setDisplayType(<span class="string">"DISPLAYONWAP"</span>);</div><div class="line">                item.setOtherParams(extra.get(<span class="string">"otherParams"</span>));<span class="comment">//将整个自定义参数传出去，在需要的地方处理</span></div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                System.out.println(<span class="string">"推送消息类型错误！"</span>);</div><div class="line">            &#125;</div><div class="line">            bundle.putSerializable(<span class="string">"message"</span>, item);<span class="comment">//传递一个序列化参数</span></div><div class="line">            intentAct.putExtras(bundle);</div><div class="line">            showNotification(context, msg, intentAct);<span class="comment">//必须要有，不然收不到推送的消息</span></div><div class="line">            <span class="comment">// 完全自定义消息的处理方式，点击或者忽略</span></div><div class="line">            <span class="keyword">boolean</span> isClickOrDismissed = <span class="keyword">true</span>;</div><div class="line">            <span class="keyword">if</span>(isClickOrDismissed) &#123;</div><div class="line">                <span class="comment">//完全自定义消息的点击统计</span></div><div class="line">                UTrack.getInstance(getApplicationContext()).trackMsgClick(msg);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">//完全自定义消息的忽略统计</span></div><div class="line">                UTrack.getInstance(getApplicationContext()).trackMsgDismissed(msg);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            Log.e(TAG, e.getMessage());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 通知栏显示当前播放信息，利用通知和 PendingIntent来启动对应的activity</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showNotification</span><span class="params">(Context context,UMessage msg,Intent intent)</span> </span>&#123;</div><div class="line">        NotificationManager mNotificationManager = (NotificationManager) getSystemService(NOTIFICATION_SERVICE);</div><div class="line">        NotificationCompat.Builder builder = <span class="keyword">new</span> NotificationCompat.Builder(context);</div><div class="line">        builder.setAutoCancel(<span class="keyword">true</span>);</div><div class="line">        Notification mNotification = builder.build();</div><div class="line">        mNotification.icon = R.drawable.ic_launcher;<span class="comment">//notification通知栏图标</span></div><div class="line">        mNotification.defaults |= Notification.DEFAULT_SOUND;</div><div class="line">        mNotification.defaults |= Notification.DEFAULT_VIBRATE ;</div><div class="line">        mNotification.tickerText=msg.ticker;</div><div class="line">        <span class="comment">//自定义布局</span></div><div class="line">        RemoteViews contentView = <span class="keyword">new</span> RemoteViews(getPackageName(), R.layout.activity_umeng_push);</div><div class="line">        contentView.setImageViewResource(R.id.Umeng_view, R.drawable.ic_launcher);</div><div class="line">        contentView.setTextViewText(R.id.push_title, msg.title);</div><div class="line">        contentView.setTextViewText(R.id.push_content, msg.text);</div><div class="line">        mNotification.contentView = contentView;</div><div class="line">        PendingIntent contentIntent = PendingIntent.getActivity(context, <span class="number">0</span>,</div><div class="line">                intent, PendingIntent.FLAG_UPDATE_CURRENT);<span class="comment">//不是Intent</span></div><div class="line">        <span class="comment">//notifcation.flags = Notification.FLAG_NO_CLEAR;// 永久在通知栏里</span></div><div class="line">        mNotification.flags = Notification.FLAG_AUTO_CANCEL;</div><div class="line">        <span class="comment">//使用自定义下拉视图时，不需要再调用setLatestEventInfo()方法，但是必须定义contentIntent</span></div><div class="line">        mNotification.contentIntent = contentIntent;</div><div class="line"></div><div class="line">        mNotificationManager.notify(<span class="number">103</span>, mNotification);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">说明：当自定义的参数中有URL时，会被转义，不要在这里面处理，把整个参数传递出去，在需要的地方进行取缔，不然会收不到推送的消息，我的message如下：</div><div class="line">   message=&#123;</div><div class="line">    <span class="string">"msg_id"</span>:<span class="string">"uu56667143874445555800"</span>,</div><div class="line">    <span class="string">"display_type"</span>:<span class="string">"notification"</span>,</div><div class="line">    <span class="string">"alias"</span>:<span class="string">""</span>,</div><div class="line">    <span class="string">"random_min"</span>:<span class="number">0</span>,</div><div class="line">    <span class="string">"body"</span>:&#123;</div><div class="line">        <span class="string">"text"</span>:<span class="string">"content"</span>,</div><div class="line">        <span class="string">"title"</span>:<span class="string">"title"</span>,</div><div class="line">        <span class="string">"ticker"</span>:<span class="string">"ticker"</span>,</div><div class="line">        <span class="string">"play_vibrate"</span>:<span class="string">"true"</span>,</div><div class="line">        <span class="string">"play_lights"</span>:<span class="string">"true"</span>,</div><div class="line">        <span class="string">"play_sound"</span>:<span class="string">"true"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"extra"</span>:&#123;</div><div class="line">        <span class="string">"otherParams"</span>:<span class="string">"</span></div><div class="line"><span class="string">            &#123;\"url\":\"http://www.baidu.com\"&#125;"</span>,</div><div class="line">            <span class="string">"displayType"</span>:<span class="string">"DISPLAYONWAP"</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">自定义的messageItem如下：</div><div class="line"><span class="keyword">package</span> com.pitaya.daokoudai.model.bean.account;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.json.JSONException;</div><div class="line"><span class="keyword">import</span> org.json.JSONObject;</div><div class="line"></div><div class="line"><span class="keyword">import</span> Java.io.Serializable;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 我的消息  bean  包含類型，時間，類容，狀態,消息未读数</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageItem</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String msmType;</div><div class="line">    <span class="keyword">private</span> Long msmDate;</div><div class="line">    <span class="keyword">private</span> String msmcontent;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> msmstatus;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> unreadmsg;</div><div class="line">    <span class="keyword">private</span> Long id;</div><div class="line">    <span class="keyword">private</span> String displayType;</div><div class="line">    <span class="keyword">private</span> String otherParams;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDisplayType</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> displayType;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDisplayType</span><span class="params">(String displayType)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.displayType = displayType;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getOtherParams</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> otherParams;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOtherParams</span><span class="params">(String otherParams)</span> </span>&#123;<span class="comment">//将参数中的\全部换成“”</span></div><div class="line">        String string=otherParams.replaceAll(<span class="string">"\\\\"</span>,<span class="string">""</span>);<span class="comment">//是4杠，不是2杠</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            JSONObject jsonObject=<span class="keyword">new</span> JSONObject(string);</div><div class="line">            <span class="keyword">this</span>.otherParams = jsonObject.optString(<span class="string">"url"</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (JSONException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTitle</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> title;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTitle</span><span class="params">(String title)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.title = title;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String title;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getUnreadmsg</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> unreadmsg;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUnreadmsg</span><span class="params">(<span class="keyword">int</span> unreadmsg)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.unreadmsg = unreadmsg;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Long id)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.id = id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMsmType</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> msmType;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMsmType</span><span class="params">(String msmType)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.msmType = msmType;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getMsmDate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> msmDate;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMsmDate</span><span class="params">(Long msmDate)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.msmDate = msmDate;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMsmcontent</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> msmcontent;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMsmcontent</span><span class="params">(String msmcontent)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.msmcontent = msmcontent;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getMsmstatus</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> msmstatus;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMsmstatus</span><span class="params">(<span class="keyword">boolean</span> msmstatus)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.msmstatus = msmstatus;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="number">2</span>,在AndroidManifest.xml 中声明。</div><div class="line"></div><div class="line">    &lt;!-- 请填写实际的类名，下面仅是示例代码--&gt;</div><div class="line">    &lt;service android:name=<span class="string">"com.umeng.message.example.MyPushIntentService"</span> android:process=<span class="string">":push"</span>/&gt;</div><div class="line"></div><div class="line">    <span class="number">3</span>,在主Activity中调用。</div><div class="line"></div><div class="line">    <span class="comment">/**推送开启 **/</span></div><div class="line">    PushAgent mPushAgent = PushAgent.getInstance(<span class="keyword">this</span>);</div><div class="line">    mPushAgent.enable();<span class="comment">//开启推送</span></div><div class="line">    mPushAgent.setDebugMode(<span class="keyword">true</span>);</div><div class="line">    mPushAgent.setPushIntentServiceClass(PushIntentService.class)</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://misayachad.github.io/2017/09/04/Umeng消息的完全自定义处理/" data-id="ckclyj7zc000inouso00ui9ib" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Android录视频静音" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/23/Android录视频静音/" class="article-date">
  <time datetime="2017-08-23T12:30:19.000Z" itemprop="datePublished">2017-08-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/23/Android录视频静音/">Android录视频静音</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Android录视频静音</p>
<p>解决录视频可以关闭/开启声音</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setMicMuted</span><span class="params">(<span class="keyword">boolean</span> state)</span></span>&#123;</div><div class="line">    AudioManager myAudioManager = (AudioManager)mContext.getSystemService(Context.AUDIO_SERVICE);</div><div class="line"></div><div class="line">    <span class="comment">// get the working mode and keep it</span></div><div class="line">    <span class="keyword">int</span> workingAudioMode = myAudioManager.getMode();</div><div class="line"></div><div class="line">    myAudioManager.setMode(AudioManager.MODE_IN_COMMUNICATION);</div><div class="line"></div><div class="line">    <span class="comment">// change mic state only if needed</span></div><div class="line">    <span class="keyword">if</span> (myAudioManager.isMicrophoneMute() != state) &#123;</div><div class="line">        myAudioManager.setMicrophoneMute(state);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// set back the original working mode</span></div><div class="line">    myAudioManager.setMode(workingAudioMode);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>refrence: <a href="https://www.itstrike.cn/Question/ef401819-3f4c-42ce-b873-5e418f076faf.html" target="_blank" rel="external">https://www.itstrike.cn/Question/ef401819-3f4c-42ce-b873-5e418f076faf.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://misayachad.github.io/2017/08/23/Android录视频静音/" data-id="ckclyj7z00003nous6zv3jn52" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Ethereum/">Ethereum</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaEE/">JavaEE</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux运维/">Linux运维</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/区块链/">区块链</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/宝典/">宝典</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/05/20/超级账本 Hyperledger Fabric2.0 多机集群部署/">超级账本 Hyperledger Fabric2.0 多机集群部署</a>
          </li>
        
          <li>
            <a href="/2018/09/10/运维进程管理supervisorctl使用/">运维进程管理supervisorctl使用</a>
          </li>
        
          <li>
            <a href="/2018/08/01/问题/">问题</a>
          </li>
        
          <li>
            <a href="/2018/06/10/Android刘海屏适配/">Android刘海屏适配</a>
          </li>
        
          <li>
            <a href="/2018/05/10/Java消息服务/">Java消息服务</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 MisayaChad<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>